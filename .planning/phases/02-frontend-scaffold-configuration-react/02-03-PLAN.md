---
phase: 02-frontend-scaffold-configuration-react
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [
  "frontend/src/features/configure/ConfigureStep.tsx",
  "frontend/src/features/configure/FieldManager.tsx",
  "frontend/src/features/configure/TemplateSelector.tsx",
  "frontend/src/api/templatesApi.ts",
  "frontend/src/api/batchesApi.ts",
  "frontend/src/store/wizardStore.ts"
]
autonomous: true
requirements: [FRONTEND-04, FRONTEND-05]
user_setup: []

must_haves:
  truths:
    - "User can add and remove metadata fields"
    - "User can select a 'Collection Type' (template) to pre-populate fields"
    - "Removing a field requires confirmation"
    - "Clarification step allows reviewing and editing custom fields"
    - "Hard Block prevents proceeding if no fields are active"
  artifacts:
    - path: "frontend/src/features/configure/FieldManager.tsx"
      provides: "Dynamic CRUD for metadata fields"
    - path: "frontend/src/features/configure/TemplateSelector.tsx"
      provides: "Dropdown linked to backend /api/v1/templates/"
    - path: "frontend/src/api/batchesApi.ts"
      provides: "TanStack Query mutation to call /api/v1/batches/"
  key_links:
    - from: "frontend/src/features/configure/ConfigureStep.tsx"
      to: "frontend/src/api/templatesApi.ts"
      via: "useQuery hook"
    - from: "frontend/src/features/configure/ConfigureStep.tsx"
      to: "frontend/src/api/batchesApi.ts"
      via: "useMutation hook"
---

<objective>
Implement Step 2 (Configure) of the wizard, enabling users to define the metadata fields to extract, choose from predefined templates (backend-synced), and finalize the batch configuration.

Purpose: Allow users to specify exactly what information they want to extract from the cards.
Output: Working Configure step with Field Manager, Template Selector, and Batch Creation API.
</objective>

<execution_context>
@/Users/martinhess/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend-scaffold-configuration-react/2-RESEARCH.md
@.planning/2-CONTEXT.md
@.planning/phases/02-frontend-scaffold-configuration-react/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Dynamic Field Management</name>
  <files>frontend/src/features/configure/FieldManager.tsx, frontend/src/features/configure/ConfigureStep.tsx</files>
  <action>
    - Create a `FieldManager` component that allows users to add/remove extraction fields.
    - Each field entry should have: a name/label and an optional description (for AI guidance).
    - Implement a confirmation dialog when removing a field (as per CONTEXT.md).
    - Use the 'archive-sepia' and 'parchment-dark' colors for field cards.
    - Validate that at least one field is defined before the user can proceed.
  </action>
  <verify>Add 3 fields. Remove 1 and check if the confirmation appears. Verify the field is gone from the UI after approval.</verify>
  <done>User can dynamically manage metadata fields with appropriate safeguards.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Templates and Collection Types</name>
  <files>frontend/src/api/templatesApi.ts, frontend/src/features/configure/TemplateSelector.tsx</files>
  <action>
    - **API Integration:** Create `templatesApi.ts` to fetch templates from the backend's `GET /api/v1/templates/` using TanStack Query.
    - **Selector Component:** Implement a dropdown in `ConfigureStep` that allows users to choose a "Collection Type".
    - **Auto-populate:** When a template is selected, populate the `wizardStore.ts` fields with the fields defined in the template.
    - Include a "Blank Slate" option to clear all fields.
  </action>
  <verify>Select a template (e.g., 'Person') and verify that fields like 'Name' and 'Birth Date' appear in the list automatically.</verify>
  <done>Predefined templates can be used to speed up configuration.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Clarification Step and Batch Creation</name>
  <files>frontend/src/features/configure/ConfigureStep.tsx, frontend/src/api/batchesApi.ts, frontend/src/store/wizardStore.ts</files>
  <action>
    - **Clarification:** Implement a final review sub-step in the Configure UI where the user explicitly confirms the fields before starting processing.
    - **Batch Creation:** Create `batchesApi.ts` with a `createBatch` mutation that calls the Backend's `POST /api/v1/batches/` with the list of files and fields.
    - **Transition:** On a successful batch creation, move the wizard to the `processing` step.
    - **Hard Block:** Ensure the "Next" button is disabled if no fields are present or no files have been successfully uploaded.
  </action>
  <verify>Finish configuration and click 'Start Processing'. Verify that a POST call is made to `/api/v1/batches/` with the correct JSON payload.</verify>
  <done>Configuration workflow is complete and linked to the batch creation process.</done>
</task>

</tasks>

<verification>
- Verify that templates are fetched correctly from the backend.
- Verify that selecting a template populates the field list.
- Verify that 'Start Processing' triggers a batch creation and advances the wizard.
</verification>

<success_criteria>
- User can configure metadata fields manually or via templates.
- Validation prevents proceeding without fields or files.
- Batch creation succeeds and advances to the next phase.
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend-scaffold-configuration-react/02-03-SUMMARY.md`
</output>

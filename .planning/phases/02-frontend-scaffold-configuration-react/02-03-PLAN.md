---
phase: 02-frontend-scaffold-configuration-react
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/features/configure/ConfigureStep.tsx
  - frontend/src/features/configure/FieldManager.tsx
  - frontend/src/features/configure/TemplateSelector.tsx
  - frontend/src/api/templatesApi.ts
  - frontend/src/api/batchesApi.ts
  - frontend/src/store/wizardStore.ts
autonomous: true
requirements:
  - FRONTEND-04
  - FRONTEND-05
user_setup: []

must_haves:
  truths:
    - "User can manually add and remove custom metadata fields for extraction"
    - "Selecting a 'Collection Type' (template) from the dropdown pre-populates fields"
    - "Removing a field (manual or template-provided) requires a confirmation toast/modal"
    - "A 'Clarification' button/review step is present before processing starts"
    - "Starting processing (next step) calls POST /api/v1/batches/ with session_id and fields"
  artifacts:
    - path: "frontend/src/features/configure/FieldManager.tsx"
      provides: "Dynamic CRUD for metadata fields with AI guidance/description support"
    - path: "frontend/src/features/configure/TemplateSelector.tsx"
      provides: "Dropdown for selecting extraction templates from /api/v1/templates/"
    - path: "frontend/src/api/batchesApi.ts"
      provides: "TanStack Query mutation to finalize the batch and start OCR"
  key_links:
    - from: "frontend/src/features/configure/ConfigureStep.tsx"
      to: "frontend/src/api/templatesApi.ts"
      via: "useQuery to fetch available predefined templates"
    - from: "frontend/src/features/configure/ConfigureStep.tsx"
      to: "frontend/src/api/batchesApi.ts"
      via: "useMutation to create the final batch and transition the wizard"
---

<objective>
Implement Step 2 (Configure) of the wizard, allowing users to define extraction fields (manually or via templates), review the batch, and initiate the OCR processing.

Purpose: Allow users to customize the metadata extraction logic to match their specific index card collection.
Output: Working Configure step with Field Manager, Template Selector, and Batch Creation API integration.
</objective>

<execution_context>
@/Users/martinhess/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend-scaffold-configuration-react/2-RESEARCH.md
@.planning/phases/02-frontend-scaffold-configuration-react/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Dynamic Field Management and Review</name>
  <files>
    - frontend/src/features/configure/FieldManager.tsx
    - frontend/src/features/configure/ConfigureStep.tsx
  </files>
  <action>
    - **FieldManager:** Implement a component that allows users to add fields (label and description). Display them in a parchment-style list.
    - **Confirmation:** Add a `sonner` confirmation for field deletion.
    - **Review:** Add a "Review Settings" toggle or final confirmation button that shows a summary of the batch (X files, Y fields) before enabling the "Start Extraction" button.
    - **Wizard Integration:** Update `wizardStore.ts` with the defined fields. Update the Footer "0 Fields" stat.
  </action>
  <verify>Add 3 custom fields, verify they appear in the UI and the footer count changes to 3. Delete one and confirm the confirmation toast shows up.</verify>
  <done>User can flexibly define the target metadata fields and review the batch summary.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Backend Templates API</name>
  <files>
    - frontend/src/api/templatesApi.ts
    - frontend/src/features/configure/TemplateSelector.tsx
  </files>
  <action>
    - **API Integration:** Create `templatesApi.ts` to fetch available templates from `GET /api/v1/templates/` using TanStack Query.
    - **TemplateSelector:** Add a "Collection Type" dropdown to `ConfigureStep`.
    - **Auto-population:** When a template is selected, update the `wizardStore.ts` fields with those from the template. Allow a "Blank" option to clear all.
  </action>
  <verify>Select 'Person' from the templates dropdown and verify that 'Name', 'Birth Date', etc., are added to the field manager list automatically.</verify>
  <done>Backend-defined extraction templates are available to speed up configuration.</done>
</task>

<task type="auto">
  <name>Task 3: Finalize Batch and Transition to Processing</name>
  <files>
    - frontend/src/api/batchesApi.ts
    - frontend/src/features/configure/ConfigureStep.tsx
  </files>
  <action>
    - **Batch Creation:** Implement `useCreateBatchMutation` in `batchesApi.ts` that calls `POST /api/v1/batches/`.
    - **Payload:** The mutation should send the `session_id` (from Step 1) and the `fields` array (labels and descriptions).
    - **Transition:** Upon success, set the `wizardStore.step` to `processing`.
    - **Hard Block:** Ensure the "Start Extraction" button is disabled if the fields list is empty.
  </action>
  <verify>Click 'Start Extraction' and verify the `POST /api/v1/batches/` request in the network tab. Confirm the wizard advances to the 'Processing' sidebar step.</verify>
  <done>The wizard successfully bridges the configuration step with the backend processing logic.</done>
</task>

</tasks>

<verification>
- Verify that templates populate fields without duplicating if selected multiple times.
- Verify that a batch can be created successfully with a mix of template and custom fields.
- Verify that 'Start Fresh' clears the configuration and returns the user to Step 1.
</verification>

<success_criteria>
- Selection of a template immediately updates the field list.
- User can manually add extraction-guiding descriptions to fields.
- Batch creation is triggered and redirects the UI to the next step.
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend-scaffold-configuration-react/02-03-SUMMARY.md`
</output>

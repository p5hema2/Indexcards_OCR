---
phase: 06-merge-features-of-main-and-current-branch-with-interview-which-feature-to-pick
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/features/results/ResultsTable.tsx
  - apps/frontend/src/features/results/ThumbnailCell.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Results table shows a single 'Extraction' column with key-value pairs (field label = key, editable value = value) instead of N individual field columns"
    - "Error messages appear as title/tooltip on the status chip, not in a separate display area or column"
    - "Retry button renders inside the status column below the status chip, not in a separate actions column"
    - "No separate actions column exists in the table"
    - "Thumbnail column renders a text link (filename), not an inline <img> element"
    - "No hover preview overlay exists on thumbnail links"
    - "Clicking the thumbnail text link opens the lightbox for full-size viewing"
    - "Only one shared Lightbox instance exists in the table, not one per row"
  artifacts:
    - path: "apps/frontend/src/features/results/ResultsTable.tsx"
      provides: "Restructured table with single Extraction column, merged status+retry+error column"
      contains: "Extraction"
    - path: "apps/frontend/src/features/results/ThumbnailCell.tsx"
      provides: "Text-link thumbnail with click-to-open shared lightbox callback"
  key_links:
    - from: "ResultsTable.tsx"
      to: "ThumbnailCell.tsx"
      via: "onOpenLightbox callback prop"
      pattern: "onOpenLightbox"
    - from: "ResultsTable.tsx"
      to: "EditableCell"
      via: "Extraction column renders EditableCell per field in a dl/dd list"
      pattern: "fields\\.map.*EditableCell"
    - from: "ResultsTable.tsx status column"
      to: "retry button + error tooltip"
      via: "status cell renders chip with title={error} and retry button below"
      pattern: "title=.*error"
---

<objective>
Close two UAT gaps (Tests 7 and 9) by restructuring the ResultsTable layout and simplifying ThumbnailCell for DOM performance.

Purpose: User reported the per-field-column layout is "nearly not usable" and inline thumbnails will cause DOM explosion at 500+ rows. These are major usability issues blocking UAT sign-off.

Output: Restructured ResultsTable.tsx with single Extraction column (key-value pairs), merged status/retry/error column, and lightweight text-link thumbnails with a single shared Lightbox.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/features/results/ResultsTable.tsx
@apps/frontend/src/features/results/ThumbnailCell.tsx
@apps/frontend/src/features/results/ResultsStep.tsx
@apps/frontend/src/store/wizardStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify ThumbnailCell to text link with shared lightbox callback</name>
  <files>apps/frontend/src/features/results/ThumbnailCell.tsx</files>
  <action>
Rewrite ThumbnailCell to be a lightweight text-link component instead of an image-rendering component.

**Remove entirely:**
- The inline `<img>` element (the 64x48 thumbnail)
- The hover preview overlay (the fixed-position 340x256 preview `<div>` with `<img>`)
- The per-row `<Lightbox>` instance
- All hover state (`preview`, `handleMouseEnter`, `handleMouseLeave`)
- The `thumbRef` ref
- The `PREVIEW_W` and `PREVIEW_H` constants
- The `Lightbox` import and its CSS import

**Change the component interface:**
- Replace props with: `{ filename: string; onOpenLightbox: (imageUrl: string) => void; batchName: string }`
- The component computes `imageUrl` from `batchName` and `filename` (same pattern: `/batches-static/${batchName}/${filename}`)

**New render:**
- Render a clickable text element (a `<button>` styled as a link or an `<a>`-like span)
- Display the filename (truncated with `truncate` + `max-w-[120px]` or similar)
- Use `lucide-react` `Image` icon (16x16) inline before the filename text for visual affordance
- On click, call `onOpenLightbox(imageUrl)`
- Keep the `imgError` state: if the URL would error, show `ImageOff` icon with muted text (but since we no longer load images, remove `imgError` entirely — there is no `<img>` to trigger `onError`. Simply render the link unconditionally.)
- Style: `font-mono text-xs text-archive-sepia hover:text-archive-sepia/80 hover:underline cursor-pointer flex items-center gap-1.5`

**Result:** Each row contributes ~1 DOM element (a button/span with text) instead of 3 (img + preview img + Lightbox). At 500 rows this reduces from ~1500 image nodes to 0 image nodes.
  </action>
  <verify>
Run `cd /Users/martinhess/workspace/hack-the-heritage/Indexcards_OCR && npx turbo typecheck --filter=frontend` — no TypeScript errors.
Confirm ThumbnailCell.tsx contains no `<img>` tags, no `Lightbox` import, no hover preview logic.
  </verify>
  <done>ThumbnailCell renders a text link with Image icon + truncated filename; calls onOpenLightbox(imageUrl) on click; zero image DOM nodes per row.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure ResultsTable — single Extraction column, merged status column, shared Lightbox</name>
  <files>apps/frontend/src/features/results/ResultsTable.tsx</files>
  <action>
Make three structural changes to the TanStack Table column definitions in ResultsTable.tsx.

**Change A — Replace N field columns with single "Extraction" column (lines 203-221):**

Remove the `...fields.map((field) => ...)` spread that creates one column per field. Replace with a single display column:

```
columnHelper.display({
  id: 'extraction',
  header: 'Extraction',
  cell: ({ row }) => {
    const r = row.original;
    const visibleFields = fields.filter(f => {
      // Skip internal fields like _entries, _entry_count
      return !f.startsWith('_');
    });
    if (visibleFields.length === 0) return null;
    return (
      <dl className="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1">
        {visibleFields.map((field) => {
          const ocrValue = r.data[field] ?? '';
          const editedValue = r.editedData[field];
          const displayValue = editedValue !== undefined ? editedValue : ocrValue;
          return (
            <React.Fragment key={field}>
              <dt className="font-mono text-xs text-archive-ink/50 whitespace-nowrap py-0.5">{field}</dt>
              <dd className="py-0.5">
                <EditableCell
                  value={displayValue}
                  isEdited={editedValue !== undefined && editedValue !== ocrValue}
                  onCommit={(v) => updateResultCell(r.filename, field, v)}
                />
              </dd>
            </React.Fragment>
          );
        })}
      </dl>
    );
  },
})
```

This renders all fields as a definition list (key-value pairs) inside a single table cell. The `grid-cols-[auto_1fr]` creates a 2-column layout: field label (auto-width) + editable value (fills remaining space).

**Change B — Merge retry button and error into the status column (lines 188-201 and 232-262):**

Remove the entire `actions` column (the `columnHelper.display({ id: 'actions', ... })` block at lines 232-262).

Expand the existing `status` column cell to include retry button and error tooltip:

```
columnHelper.accessor('status', {
  header: 'Status',
  enableSorting: true,
  cell: ({ row }) => {
    const r = row.original;
    if (r._isSubRow) return null;
    const s = r.status;
    const isRetrying = retryingFilename === r._pageFilename;
    return (
      <div className="flex flex-col items-start gap-1.5">
        <span
          className={`px-2 py-0.5 rounded text-xs uppercase tracking-widest font-semibold ${statusStyles[s]}`}
          title={r.error || undefined}
        >
          {s}
        </span>
        {s === 'failed' && (
          <button
            onClick={() => onRetryImage(r._pageFilename)}
            disabled={isProcessing || isRetrying}
            className="flex items-center gap-1 px-2 py-1 text-xs border border-parchment-dark rounded text-archive-ink/60 hover:text-archive-ink hover:border-archive-sepia transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
          >
            {isRetrying
              ? <Loader2 className="w-3 h-3 animate-spin" />
              : <RotateCcw className="w-3 h-3" />}
            {isRetrying ? 'Retrying...' : 'Retry'}
          </button>
        )}
      </div>
    );
  },
})
```

Key points:
- The status chip gets `title={r.error || undefined}` so the error message appears as a native browser tooltip on hover
- The retry button renders directly below the status chip when status is 'failed'
- No separate actions column exists

**Change C — Add shared Lightbox and wire ThumbnailCell callback:**

Add state at the top of the component (alongside existing `sorting` state):
```
const [lightboxSrc, setLightboxSrc] = useState<string | null>(null);
```

Update the thumbnail column to pass the callback:
```
columnHelper.display({
  id: 'thumbnail',
  header: 'Image',
  cell: ({ row }) => {
    const r = row.original;
    return r._isSubRow
      ? <span className="block w-8 border-l-2 border-archive-sepia/20 ml-3" />
      : <ThumbnailCell
          batchName={batchName}
          filename={r._pageFilename}
          onOpenLightbox={(src) => setLightboxSrc(src)}
        />;
  },
})
```

Add a single shared Lightbox instance at the bottom of the component return, just before the closing `</div>`:
```
import Lightbox from 'yet-another-react-lightbox';
import 'yet-another-react-lightbox/styles.css';

// ... inside the return, after the table and empty-state message:
<Lightbox
  open={lightboxSrc !== null}
  close={() => setLightboxSrc(null)}
  slides={lightboxSrc ? [{ src: lightboxSrc }] : []}
/>
```

Move the Lightbox import and CSS import from ThumbnailCell.tsx to ResultsTable.tsx (since ThumbnailCell no longer uses it).

**Column order after restructure:** thumbnail, filename, status (with retry+error), extraction, time.

The `duration` column remains unchanged.
  </action>
  <verify>
Run `cd /Users/martinhess/workspace/hack-the-heritage/Indexcards_OCR && npx turbo typecheck --filter=frontend` — no TypeScript errors.

Confirm in ResultsTable.tsx:
1. No `id: 'actions'` column exists (grep for "actions" in column defs)
2. A single `id: 'extraction'` column exists with `<dl>` layout
3. Status column cell includes `title={r.error` for tooltip
4. Status column cell includes retry `<button>` for failed rows
5. A single `<Lightbox>` component exists at component level (not per-row)
6. ThumbnailCell receives `onOpenLightbox` prop

Run `cd /Users/martinhess/workspace/hack-the-heritage/Indexcards_OCR && npx turbo build --filter=frontend` — build succeeds.
  </verify>
  <done>
ResultsTable has 5 columns (thumbnail, filename, status, extraction, time). Field data renders as key-value dl/dd pairs in single Extraction column. Error shows as tooltip on status chip. Retry button is inside status column. Actions column is removed. One shared Lightbox instance serves all rows.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx turbo typecheck --filter=frontend` passes with zero errors
2. `npx turbo build --filter=frontend` produces a successful build
3. ResultsTable.tsx column count: 5 (thumbnail, filename, status, extraction, time) — no actions column, no per-field columns
4. ThumbnailCell.tsx has zero `<img>` tags and zero `Lightbox` imports
5. ResultsTable.tsx has exactly one `<Lightbox` instance
6. Grep for `fields.map.*columnHelper` in ResultsTable.tsx returns zero matches (field spread removed)
7. Grep for `id: 'actions'` in ResultsTable.tsx returns zero matches (actions column removed)
</verification>

<success_criteria>
- UAT Test 7 resolved: Extraction data displays as key-value pairs in single column; error as tooltip on status chip; retry button below status chip in status column; no separate actions column
- UAT Test 9 resolved: No inline images in table rows; text links replace thumbnails; single shared Lightbox; DOM node count per row reduced from ~3 image elements to 0
- TypeScript compiles without errors
- Frontend builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06-merge-features-of-main-and-current-branch-with-interview-which-feature-to-pick/06-07-SUMMARY.md`
</output>

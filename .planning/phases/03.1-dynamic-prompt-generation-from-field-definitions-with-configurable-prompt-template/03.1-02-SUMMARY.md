---
phase: 03.1-dynamic-prompt-generation-from-field-definitions-with-configurable-prompt-template
plan: 02
subsystem: ui
tags: [react, zustand, prompt-template, configure-step, live-preview, tailwind]

dependency_graph:
  requires:
    - phase: 03.1-01
      provides: prompt_template in all backend data models and OCR pipeline wiring
  provides:
    - PromptTemplateEditor component (collapsible, edit/preview, reset)
    - promptTemplate Zustand state with localStorage persistence
    - prompt_template in Template interface and create/update mutation types
    - prompt_template in BatchCreate interface and createBatch payload
    - TemplateSelector sets promptTemplate on load, clears on blank select
    - FieldManager includes prompt_template when saving templates
  affects:
    - Configure step UI (right column, below FieldManager)
    - Template save/load workflows
    - Batch creation payloads

tech-stack:
  added: []
  patterns:
    - Zustand partialize for selective localStorage persistence
    - Collapsible UI section with useState toggle + ChevronDown rotation
    - Live prompt preview with {{fields}} substitution matching backend logic
    - null-means-default pattern: null in store = use backend default; non-null = custom override

key-files:
  created:
    - apps/frontend/src/features/configure/PromptTemplateEditor.tsx
  modified:
    - apps/frontend/src/store/wizardStore.ts
    - apps/frontend/src/api/templatesApi.ts
    - apps/frontend/src/api/batchesApi.ts
    - apps/frontend/src/features/configure/TemplateSelector.tsx
    - apps/frontend/src/features/configure/FieldManager.tsx
    - apps/frontend/src/features/configure/ConfigureStep.tsx

key-decisions:
  - "DEFAULT_TEMPLATE constant in PromptTemplateEditor matches ocr_engine.py hardcoded German prompt exactly — identical text ensures null sentinel works correctly"
  - "onChange sets null when user types exactly DEFAULT_TEMPLATE: no-op storage, backend uses its own default"
  - "PromptTemplateEditor collapsed by default: non-intrusive for users who never need to customize"
  - "Edit/Preview toggle as text buttons (not tabs): lightweight UI consistent with existing archive aesthetic"

metrics:
  duration: ~5min
  completed_date: 2026-02-22
  tasks: 2
  files: 7
---

# Phase 03.1 Plan 02: Prompt Template Editor UI Summary

**PromptTemplateEditor React component wired to Zustand store with live {{fields}} preview, plus prompt_template propagated through template save/load, batch creation, and localStorage persistence.**

## Performance

- **Duration:** ~5 min
- **Started:** 2026-02-22T15:33:58Z
- **Completed:** 2026-02-22T15:39:00Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Created `PromptTemplateEditor` component: collapsible panel, edit/preview toggle, DEFAULT_TEMPLATE constant matching backend, live preview with fields substituted, reset-to-default button
- Wired `promptTemplate` state and `setPromptTemplate` action into Zustand `WizardState` interface with `initialState` and `partialize` (localStorage persistence)
- Propagated `prompt_template` through all frontend data flows: Template interface, BatchCreate interface, template save mutation, template load (TemplateSelector), batch creation (ConfigureStep)

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend Zustand store, API layers, and template/batch data flows with prompt_template** - `be7f28f` (feat)
2. **Task 2: Create PromptTemplateEditor component and integrate into ConfigureStep** - `5697a49` (feat)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `apps/frontend/src/features/configure/PromptTemplateEditor.tsx` - New collapsible prompt template editor component with edit/preview modes and live field substitution
- `apps/frontend/src/store/wizardStore.ts` - Added `promptTemplate: string | null`, `setPromptTemplate` action, initialState entry, and partialize entry
- `apps/frontend/src/api/templatesApi.ts` - Added `prompt_template?: string | null` to `Template` interface and both mutation data types
- `apps/frontend/src/api/batchesApi.ts` - Added `prompt_template?: string | null` to `BatchCreate` interface
- `apps/frontend/src/features/configure/TemplateSelector.tsx` - Calls `setPromptTemplate` on template load and `setPromptTemplate(null)` on blank select; passes `t.prompt_template` to `handleSelectTemplate`
- `apps/frontend/src/features/configure/FieldManager.tsx` - Includes `prompt_template: promptTemplate` in `createTemplateMutation.mutate()` call
- `apps/frontend/src/features/configure/ConfigureStep.tsx` - Imports `PromptTemplateEditor`, places it below `FieldManager` in right column, includes `prompt_template: promptTemplate` in `createBatchMutation.mutate()` call

## Decisions Made

- DEFAULT_TEMPLATE in `PromptTemplateEditor.tsx` is a verbatim copy of the hardcoded German prompt in `ocr_engine.py`. This is intentional: when a user types the default text back in, `onChange` sees `val === DEFAULT_TEMPLATE` and stores `null`, so the backend's own default runs instead of a duplicate custom template string.
- `PromptTemplateEditor` is collapsed by default — most users will not need to customize the prompt; power users can expand when needed.
- Edit/Preview toggle uses plain underlined text buttons for minimal visual weight, consistent with the archive aesthetic.
- `null`-as-default sentinel preserved throughout: `null` in store means "use backend default"; non-null string means custom override.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All frontend data flows for `prompt_template` are complete end-to-end: store -> save template -> load template -> create batch -> backend OCR pipeline
- Ready for UAT: user can expand the editor in Configure step, edit or preview the prompt, reset to default, and the value is included in all API calls
- No blockers

---
*Phase: 03.1-dynamic-prompt-generation-from-field-definitions-with-configurable-prompt-template*
*Completed: 2026-02-22*

## Self-Check: PASSED

All 7 modified/created files confirmed present on disk. Both task commits (be7f28f, 5697a49) confirmed in git log.

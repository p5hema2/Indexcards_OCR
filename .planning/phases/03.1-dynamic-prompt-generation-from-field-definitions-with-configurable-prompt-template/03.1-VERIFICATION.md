---
phase: 03.1-dynamic-prompt-generation-from-field-definitions-with-configurable-prompt-template
verified: 2026-02-22T16:00:00Z
status: passed
score: 12/12 must-haves verified
re_verification: false
---

# Phase 03.1: Dynamic Prompt Generation Verification Report

**Phase Goal:** Add an optional `prompt_template` field to templates and batches, wire it through the backend OCR pipeline with `{{fields}}` placeholder substitution, and surface a collapsible prompt editor with live preview in the Configure step UI.
**Verified:** 2026-02-22T16:00:00Z
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| #  | Truth | Status | Evidence |
|----|-------|--------|----------|
| 1  | `prompt_template` field exists in Template, TemplateCreate, TemplateUpdate, BatchCreate, and BatchConfig data models | VERIFIED | Present in template.schema.json (3x), batch.schema.json (2x), generated/ts/index.ts (5x), generated/py/template.py (3x), generated/py/batch.py (2x), schemas.py (5x) |
| 2  | `config.json` written by `create_batch()` includes `prompt_template` value (null when not provided) | VERIFIED | `batch_manager.py` line 50: `"prompt_template": prompt_template` in `config_data` dict |
| 3  | `run_ocr_task` reads `prompt_template` from config.json and passes it to `process_batch` | VERIFIED | `batches.py` lines 33–34: `prompt_template = config.get("prompt_template")`, passed at line 49 |
| 4  | `OcrEngine._generate_prompt()` renders a custom template when `prompt_template` is non-null, falling back to the existing hardcoded prompt when null | VERIFIED | `ocr_engine.py` lines 78–105: template substitution with `{{fields}}` replace, append fallback, and full default German prompt on `template is None` |
| 5  | Existing batches without `prompt_template` in config.json continue to work (backward compat via `.get()`) | VERIFIED | `batches.py` line 33: `config.get("prompt_template")` — `.get()` returns `None` when key absent |
| 6  | User can see and edit a prompt template textarea in the Configure step | VERIFIED | `PromptTemplateEditor.tsx` exists (102 lines), mounted in `ConfigureStep.tsx` line 119 below `<FieldManager />` |
| 7  | User can see a live preview of the rendered prompt with current fields substituted | VERIFIED | `PromptTemplateEditor.tsx` lines 25–31: `fieldsBlock` computed from store fields, `preview` replaces `{{fields}}` or appends |
| 8  | User can reset the prompt template to the default | VERIFIED | `PromptTemplateEditor.tsx` lines 89–96: reset button visible when `promptTemplate !== null`, calls `setPromptTemplate(null)` |
| 9  | Saving a template persists the `prompt_template` alongside fields | VERIFIED | `FieldManager.tsx` line 53: `createTemplateMutation.mutate({ name, fields: ..., prompt_template: promptTemplate })` |
| 10 | Loading a template from TemplateSelector applies its `prompt_template` to the store | VERIFIED | `TemplateSelector.tsx` line 30: `setPromptTemplate(promptTemplate ?? null)` in `handleSelectTemplate`; line 94 passes `t.prompt_template` |
| 11 | Starting a batch sends `prompt_template` in the BatchCreate payload | VERIFIED | `ConfigureStep.tsx` line 48: `prompt_template: promptTemplate` in `createBatchMutation.mutate()` payload |
| 12 | `promptTemplate` state persists across page refresh via Zustand localStorage | VERIFIED | `wizardStore.ts` line 206: `promptTemplate: state.promptTemplate` in `partialize` block |

**Score:** 12/12 truths verified

---

## Required Artifacts

### Plan 01 Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `packages/shared-types/schemas/template.schema.json` | `prompt_template` in Template, TemplateCreate, TemplateUpdate | VERIFIED | 3 definitions, all contain `prompt_template` with `anyOf [string, null]` |
| `packages/shared-types/schemas/batch.schema.json` | `prompt_template` in BatchConfig and BatchCreate | VERIFIED | 2 definitions carry `prompt_template` |
| `packages/shared-types/generated/ts/index.ts` | TypeScript interfaces with `prompt_template` | VERIFIED | 5 matches at lines 5, 12, 57, 63, 69 |
| `apps/backend/app/models/schemas.py` | Pydantic models with `prompt_template: Optional[str] = None` | VERIFIED | 5 classes: BatchConfig (28), BatchCreate (34), Template (57), TemplateCreate (62), TemplateUpdate (67) |
| `apps/backend/app/services/ocr_engine.py` | `_generate_prompt` with template param and `{{fields}}` substitution | VERIFIED | Lines 78–105: full implementation with replace, append fallback, and default path |
| `apps/backend/app/api/api_v1/endpoints/batches.py` | `prompt_template` read from config.json and passed to `process_batch` | VERIFIED | Lines 33–34 (read), line 49 (pass to process_batch), line 108 (pass from create endpoint) |

### Plan 02 Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `apps/frontend/src/features/configure/PromptTemplateEditor.tsx` | Collapsible editor, textarea, hint, preview, reset (min 40 lines) | VERIFIED | 102 lines; full implementation with isExpanded, isPreview, DEFAULT_TEMPLATE, live preview, reset button |
| `apps/frontend/src/store/wizardStore.ts` | `promptTemplate` state and `setPromptTemplate` action | VERIFIED | `WizardState` interface (line 74), `initialState` (line 106), setter (line 122), `partialize` (line 206) |
| `apps/frontend/src/api/batchesApi.ts` | `prompt_template` in BatchCreate interface | VERIFIED | Line 10: `prompt_template?: string \| null` |
| `apps/frontend/src/api/templatesApi.ts` | `prompt_template` in Template interface and mutation types | VERIFIED | Lines 9, 27, 46: interface and both mutation data types |

---

## Key Link Verification

### Plan 01 Key Links

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `batches.py` | `ocr_engine.py` | `prompt_template=prompt_template` passed to `process_batch` | WIRED | Line 49: `prompt_template=prompt_template` kwarg confirmed |
| `batches.py` | `batch_manager.py` | `prompt_template=batch_data.prompt_template` in `create_batch()` | WIRED | Line 108: `prompt_template=batch_data.prompt_template` confirmed |
| `ocr_engine.py` | generated prompt | `_generate_prompt` uses `template.replace("{{fields}}", ...)` | WIRED | Lines 88–91: replace branch + append fallback both implemented |

### Plan 02 Key Links

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `PromptTemplateEditor.tsx` | `wizardStore.ts` | `useWizardStore` reads `fields` + `promptTemplate`, calls `setPromptTemplate` | WIRED | Line 19: destructures all three; onChange calls `setPromptTemplate` at line 77 |
| `ConfigureStep.tsx` | `batchesApi.ts` | `createBatchMutation` payload includes `prompt_template: promptTemplate` | WIRED | Line 48: `prompt_template: promptTemplate` confirmed in payload |
| `TemplateSelector.tsx` | `wizardStore.ts` | `handleSelectTemplate` calls `setPromptTemplate` with loaded template's value | WIRED | Lines 9, 30: destructures `setPromptTemplate`, calls it in `handleSelectTemplate` and `handleSelectBlank` |
| `FieldManager.tsx` | `templatesApi.ts` | `handleSaveTemplate` includes `promptTemplate` in create mutation payload | WIRED | Line 53: `prompt_template: promptTemplate` in `createTemplateMutation.mutate()` call |

---

## Anti-Patterns Found

No blockers or warnings found.

The two `return null` occurrences in the configure directory are legitimate guard clauses (`ImagePreview.tsx` when no file, `SaveTemplateDialog.tsx` when not open) — not stubs.

No `TODO`, `FIXME`, `PLACEHOLDER`, or empty handler stubs detected in any modified file.

---

## Human Verification Required

### 1. Collapsible Editor — Expand/Collapse Behavior

**Test:** Navigate to Configure step. Verify "Prompt Template" header section is collapsed by default. Click the header to expand. Verify textarea appears with default German text and `{{fields}}` visible.
**Expected:** Editor is collapsed on page load; expands on click; textarea shows full DEFAULT_TEMPLATE text.
**Why human:** Visual rendering and CSS transition cannot be verified programmatically.

### 2. Live Preview — Field Substitution

**Test:** With 2+ fields defined (e.g., "Komponist", "Titel"), expand the Prompt Template editor and click "Preview". Verify the preview block shows the numbered field list substituted for `{{fields}}`.
**Expected:** Preview shows `1. **Komponist**: Extrahiere den Wert fur das Feld 'Komponist'.` etc. in place of `{{fields}}`.
**Why human:** DOM rendering and text substitution output requires visual confirmation.

### 3. Reset Button Visibility

**Test:** Modify the textarea (type any change). Verify "Reset to default" button appears. Click it. Verify textarea reverts to DEFAULT_TEMPLATE text and reset button disappears.
**Expected:** Button only visible when `promptTemplate !== null`; clicking resets to null/default.
**Why human:** Conditional rendering and state transition requires interactive testing.

### 4. Template Save/Load Round-Trip

**Test:** Add fields, type a custom prompt template, save as a template. Then select "Custom / Blank Slate" and confirm editor clears. Re-select the saved template. Verify the custom prompt template is restored in the editor.
**Expected:** Custom prompt template persists through the save/load cycle.
**Why human:** Requires API interaction and verifying state restoration across UI interactions.

---

## Git Commits Verified

All 4 task commits confirmed in git history:

| Commit | Plan | Task |
|--------|------|------|
| `34fa5de` | 01 | Add prompt_template to JSON Schemas, generated types, Pydantic models |
| `4b9d95c` | 01 | Wire prompt_template through backend OCR pipeline |
| `be7f28f` | 02 | Wire prompt_template through store, APIs, template/batch flows |
| `5697a49` | 02 | Create PromptTemplateEditor component and integrate into ConfigureStep |

---

## Summary

Phase 03.1 fully achieves its goal. All 12 observable truths are verified against the actual codebase:

- **Schema layer:** `prompt_template` is present in all 5 model definitions across JSON Schema source, generated TypeScript (5 interfaces), generated Python (5 fields), and Pydantic models (5 classes).
- **Backend pipeline:** The field flows end-to-end — `BatchCreate` body → `batch_manager.create_batch()` writes it to `config.json` → `run_ocr_task` reads it via `.get()` (backward compat confirmed) → `process_batch` → `_process_card_sync` → `_call_vlm_api_resilient` → `_generate_prompt` renders custom template with `{{fields}}` substitution, append fallback, or default German prompt.
- **Frontend:** `PromptTemplateEditor` (102 lines, substantive implementation) is mounted in `ConfigureStep` below `FieldManager`. Zustand store carries `promptTemplate` with `partialize` persistence. `TemplateSelector` applies `prompt_template` on load and clears on blank select. `FieldManager` includes it in save mutations. `ConfigureStep` includes it in batch creation.
- **No stubs, no orphaned artifacts, no anti-patterns detected.**

Human verification is recommended for the visual/interactive behaviors (collapse animation, live preview rendering, reset button visibility, template round-trip).

---

_Verified: 2026-02-22T16:00:00Z_
_Verifier: Claude (gsd-verifier)_

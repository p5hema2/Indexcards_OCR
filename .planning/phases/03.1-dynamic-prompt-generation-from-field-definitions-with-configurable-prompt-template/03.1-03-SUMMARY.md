---
phase: 03.1-dynamic-prompt-generation-from-field-definitions-with-configurable-prompt-template
plan: 03
subsystem: api, ui
tags: [prompt-template, ocr, template-service, pydantic, react, zustand]

# Dependency graph
requires:
  - phase: 03.1-plan-01
    provides: prompt_template field in all schema types and OCR pipeline
  - phase: 03.1-plan-02
    provides: PromptTemplateEditor UI with DEFAULT_TEMPLATE constant

provides:
  - Domain-agnostic default prompt in both frontend (DEFAULT_TEMPLATE) and backend (_generate_prompt fallback)
  - prompt_template persistence in template_service.py create_template() and update_template()
affects: [UAT-tests, template-save-load, ocr-engine-default-prompt]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "null-means-default: DEFAULT_TEMPLATE (frontend) and _generate_prompt fallback (backend) are character-identical so null sentinel correctly identifies when user has reset to default"
    - "is-not-None guard for optional PATCH fields: prompt_template update follows same pattern as name/fields in update_template()"

key-files:
  created: []
  modified:
    - apps/frontend/src/features/configure/PromptTemplateEditor.tsx
    - apps/backend/app/services/ocr_engine.py
    - apps/backend/app/services/template_service.py
    - apps/backend/app/core/config.py

key-decisions:
  - "Domain-agnostic default prompt removes 'aus dem Bereich Musik' from all three prompt locations (PromptTemplateEditor, ocr_engine, config.py EXTRACTION_PROMPT)"
  - "prompt_template persisted via constructor arg on create and is-not-None guard on update — consistent with existing name/fields pattern"

patterns-established:
  - "Null-means-default sentinel: identical string in frontend DEFAULT_TEMPLATE and backend _generate_prompt fallback enables round-trip detection without comparing content"

# Metrics
duration: ~2min
completed: 2026-02-22
---

# Phase 03.1 Plan 03: UAT Gap Closure (Domain-Agnostic Prompt + Template Persistence) Summary

**Removed music-domain-specific default prompt from frontend/backend and fixed template_service to persist prompt_template through create/update round-trips**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-22T16:55:32Z
- **Completed:** 2026-02-22T16:57:44Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Removed "aus dem Bereich Musik" from PromptTemplateEditor.tsx DEFAULT_TEMPLATE (frontend)
- Removed "aus dem Bereich Musik" from ocr_engine.py _generate_prompt() hardcoded fallback (backend)
- Both DEFAULT_TEMPLATE strings remain character-identical after fix (null-means-default sentinel preserved)
- Fixed create_template() to pass prompt_template to Template constructor
- Fixed update_template() to update prompt_template with is-not-None guard

## Task Commits

Each task was committed atomically:

1. **Task 1: Make default prompt domain-agnostic in frontend and backend** - `d246f64` (fix)
2. **Task 2: Fix template_service to persist prompt_template on create and update** - `2f59454` (fix)

**Plan metadata:** pending (docs: complete plan)

## Files Created/Modified
- `apps/frontend/src/features/configure/PromptTemplateEditor.tsx` - Removed "aus dem Bereich Musik" from DEFAULT_TEMPLATE constant
- `apps/backend/app/services/ocr_engine.py` - Removed "aus dem Bereich Musik" from _generate_prompt() default f-string
- `apps/backend/app/services/template_service.py` - Added prompt_template to create_template() constructor + is-not-None guard in update_template()
- `apps/backend/app/core/config.py` - Removed "aus dem Bereich Musik" from legacy EXTRACTION_PROMPT (deviation auto-fix)

## Decisions Made
- Kept is-not-None guard for prompt_template in update_template() — consistent with existing name/fields pattern; null/absent value leaves existing prompt unchanged
- Also fixed config.py EXTRACTION_PROMPT to satisfy overall verification check requiring zero matches for "aus dem Bereich Musik" in source files

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Removed "aus dem Bereich Musik" from config.py EXTRACTION_PROMPT**
- **Found during:** Task 2 (overall verification step)
- **Issue:** Plan's verification criterion #1 requires zero matches for "aus dem Bereich Musik" across apps/; config.py contained the phrase in the legacy EXTRACTION_PROMPT fallback
- **Fix:** Removed " aus dem Bereich Musik" from the first line of EXTRACTION_PROMPT in config.py
- **Files modified:** apps/backend/app/core/config.py
- **Verification:** grep across apps/ source files (*.py, *.ts, *.tsx) returns zero matches
- **Committed in:** 2f59454 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 - bug in config.py legacy prompt)
**Impact on plan:** Necessary to satisfy the plan's stated verification criterion. No scope creep.

## Issues Encountered
- None — all verification checks passed on first attempt.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- UAT Tests 1 and 6 should now pass: default prompt is domain-agnostic; template save/load round-trips prompt_template
- Phase 03.1 gap closure complete — ready for next phase or final UAT verification run

---
*Phase: 03.1-dynamic-prompt-generation-from-field-definitions-with-configurable-prompt-template*
*Completed: 2026-02-22*

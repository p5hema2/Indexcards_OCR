---
phase: 02.1-add-turbo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - turbo.json
  - .gitignore
  - .env.example
  - apps/frontend/vite.config.ts
  - apps/backend/app/core/config.py
autonomous: true

must_haves:
  truths:
    - "Repo structure uses apps/frontend, apps/backend, apps/legacy, packages/ layout"
    - "git log --follow shows preserved history for moved files"
    - "Root package.json declares npm workspaces covering apps/* and packages/*"
    - "turbo.json defines full task pipeline with correct dependency graph"
    - "Single .env at repo root is readable by both frontend (Vite envDir) and backend (pydantic-settings)"
  artifacts:
    - path: "package.json"
      provides: "Root workspace orchestration"
      contains: "workspaces"
    - path: "turbo.json"
      provides: "Turborepo task pipeline"
      contains: "tasks"
    - path: "apps/frontend/vite.config.ts"
      provides: "Vite config pointing envDir to repo root"
      contains: "envDir"
    - path: "apps/backend/app/core/config.py"
      provides: "pydantic-settings reading .env from repo root"
      contains: "../../.env"
    - path: "apps/legacy/indexcard_ocr.py"
      provides: "Legacy OCR script preserved in apps/legacy/"
  key_links:
    - from: "package.json"
      to: "turbo.json"
      via: "turbo scripts delegate to turbo.json tasks"
      pattern: "turbo run"
    - from: "apps/backend/app/core/config.py"
      to: ".env"
      via: "pydantic-settings env_file tuple"
      pattern: '../../\.env'
    - from: "apps/frontend/vite.config.ts"
      to: ".env"
      via: "Vite envDir resolution"
      pattern: "envDir.*\\.\\./\\.\\."
---

<objective>
Migrate the flat frontend/backend/ repo structure to the Turborepo apps/ + packages/ convention, set up root workspace orchestration with turbo.json task pipeline, and fix all .env path resolution so the single root .env is accessible from both apps.

Purpose: This is the foundational restructure that all subsequent plans depend on. Without the correct directory layout and workspace config, no turbo commands can run.

Output: Restructured repo with apps/frontend, apps/backend, apps/legacy, packages/ directories; root package.json with npm workspaces; turbo.json with full task pipeline; working .env resolution from both apps.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-add-turbo/02.1-RESEARCH.md
@frontend/vite.config.ts
@backend/app/core/config.py
@.gitignore
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate directory structure with git mv</name>
  <files>
    apps/frontend/ (moved from frontend/)
    apps/backend/ (moved from backend/)
    apps/legacy/indexcard_ocr.py
    apps/legacy/config.py
    apps/legacy/requirements.txt
    apps/legacy/tests/
    packages/ (empty skeleton)
  </files>
  <action>
Migrate the repo from flat to Turborepo convention using `git mv` to preserve history.

**Step 1: Create target directories**
```bash
mkdir -p apps packages/shared-types apps/legacy
```

**Step 2: Move frontend**
```bash
git mv frontend apps/frontend
```
This moves the entire directory including hidden files (.gitignore inside frontend/).

**Step 3: Move backend**
```bash
git mv backend apps/backend
```

**Step 4: Move legacy root files**
Move these root-level Python files to apps/legacy/:
```bash
git mv indexcard_ocr.py apps/legacy/
git mv config.py apps/legacy/
git mv requirements.txt apps/legacy/
git mv tests apps/legacy/
```

**Step 5: Move other root-level artifacts**
Move output_batches to apps/legacy/ (it's the legacy output dir):
```bash
git mv output_batches apps/legacy/
```

Keep at root (do NOT move): `.env.example`, `.gitignore`, `LICENSE`, `README.md`, `.planning/`

**Step 6: Verify**
Confirm `apps/frontend/package.json`, `apps/backend/app/main.py`, `apps/legacy/indexcard_ocr.py` all exist. Confirm `frontend/` and `backend/` directories no longer exist at root.

Do NOT commit yet -- the entire restructure will be committed as a single atomic commit at the end of this plan.
  </action>
  <verify>
ls apps/frontend/package.json apps/backend/app/main.py apps/legacy/indexcard_ocr.py apps/legacy/config.py apps/legacy/tests/test_indexcard_ocr.py && echo "Migration OK"
test ! -d frontend && test ! -d backend && echo "Old dirs removed OK"
  </verify>
  <done>All files moved to apps/ structure with git mv. frontend/, backend/, and legacy root files no longer exist at root level. apps/frontend, apps/backend, apps/legacy all populated.</done>
</task>

<task type="auto">
  <name>Task 2: Create root package.json, turbo.json, and update .gitignore</name>
  <files>
    package.json
    turbo.json
    .gitignore
    .env.example
  </files>
  <action>
**Step 1: Create root package.json**

Create `package.json` at repo root:
```json
{
  "name": "indexcards-ocr",
  "private": true,
  "version": "0.0.0",
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "format": "turbo run format",
    "clean": "turbo run clean",
    "setup": "node scripts/setup.mjs"
  },
  "devDependencies": {
    "turbo": "^2.8.10"
  },
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "packageManager": "npm@11.6.2"
}
```

**Step 2: Create turbo.json**

Create `turbo.json` at repo root. This is the task pipeline per locked decisions:
- `typecheck` before `build` (locked)
- `lint` independent / no deps (locked)
- `test` after `build` (locked)
- `dev` persistent, no deps
- Local caching only (locked -- no remote cache)

```json
{
  "$schema": "https://turborepo.dev/schema.json",
  "ui": "stream",
  "globalEnv": ["NODE_ENV"],
  "globalPassThroughEnv": ["OPENROUTER_API_KEY"],
  "tasks": {
    "dev": {
      "cache": false,
      "persistent": true,
      "dependsOn": []
    },
    "build": {
      "dependsOn": ["^build", "typecheck"],
      "outputs": ["dist/**"]
    },
    "typecheck": {
      "dependsOn": ["^build"],
      "outputs": []
    },
    "test": {
      "dependsOn": ["build"],
      "outputs": ["coverage/**"],
      "inputs": ["src/**", "tests/**", "test_*.py", "*.config.*"]
    },
    "lint": {
      "outputs": [],
      "inputs": ["src/**", "app/**", "*.config.*"]
    },
    "format": {
      "cache": false,
      "outputs": []
    },
    "clean": {
      "cache": false
    },
    "generate": {
      "outputs": ["generated/**"],
      "inputs": ["schemas/**"]
    }
  }
}
```

**Step 3: Update .gitignore**

Append to the existing `.gitignore`:
```
# Turborepo
.turbo

# Node (root workspace)
node_modules/
```

Verify `node_modules/` and `.turbo` are both gitignored. The existing `.gitignore` already covers `.env`, `.venv`, `__pycache__/`, `.mypy_cache/`, `.ruff_cache/`.

**Step 4: Keep .env.example at root**

The `.env.example` already exists at root with `OPENROUTER_API_KEY=your_api_key_here`. Leave it as-is. This is where the single shared `.env` will live (per locked decision).
  </action>
  <verify>
cat package.json | python3 -c "import sys,json; d=json.load(sys.stdin); assert d['workspaces'] == ['apps/*', 'packages/*']; assert 'turbo' in d['devDependencies']; print('Root package.json OK')"
cat turbo.json | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'tasks' in d; assert d['tasks']['dev']['persistent']==True; assert 'typecheck' in d['tasks']['build']['dependsOn']; print('turbo.json OK')"
grep -q '.turbo' .gitignore && echo ".gitignore OK"
  </verify>
  <done>Root package.json with npm workspaces, turbo.json with full task pipeline (dev/build/test/lint/typecheck/format/clean/generate), and .gitignore updated with Turborepo + Node entries.</done>
</task>

<task type="auto">
  <name>Task 3: Fix .env path resolution for backend and frontend</name>
  <files>
    apps/backend/app/core/config.py
    apps/frontend/vite.config.ts
  </files>
  <action>
After migration, both apps are 2 directories deeper. The single .env lives at repo root. Fix both apps to find it.

**Step 1: Update pydantic-settings .env path in backend config**

Edit `apps/backend/app/core/config.py`. Change the `Config` inner class:
```python
class Config:
    env_file = ("../../.env", ".env")  # repo root first, then local fallback
    case_sensitive = True
```

The tuple form makes pydantic-settings check `../../.env` (repo root from `apps/backend/`) first, then `.env` locally as fallback. This is the recommended approach from research.

**Step 2: Update Vite envDir in frontend config**

Edit `apps/frontend/vite.config.ts`. Add `path` import and `envDir`:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  envDir: path.resolve(__dirname, '../..'),
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
      '/ws': {
        target: 'http://localhost:8000',
        ws: true,
      },
    },
  },
})
```

`@types/node` is already in the frontend's devDependencies so the `path` import will resolve.

**Step 3: Verify no other hardcoded path references exist**

Run a quick grep for `env_file` and `envDir` patterns in the moved files to confirm no other places need updating. The research confirmed no runtime hardcoded paths exist beyond these two files.
  </action>
  <verify>
grep -q '../../.env' apps/backend/app/core/config.py && echo "Backend .env path OK"
grep -q 'envDir' apps/frontend/vite.config.ts && echo "Frontend envDir OK"
grep -q "path.resolve" apps/frontend/vite.config.ts && echo "Frontend path.resolve OK"
  </verify>
  <done>Backend pydantic-settings reads .env from repo root via tuple ("../../.env", ".env"). Frontend Vite reads .env from repo root via envDir pointing to ../..</done>
</task>

</tasks>

<verification>
After all 3 tasks:

1. **Directory structure is correct:**
   ```
   ls apps/frontend/package.json apps/backend/app/main.py apps/legacy/indexcard_ocr.py packages/
   ```

2. **Root config files exist and are valid:**
   ```
   cat package.json | python3 -m json.tool > /dev/null && echo "Valid JSON"
   cat turbo.json | python3 -m json.tool > /dev/null && echo "Valid JSON"
   ```

3. **Git history preserved:**
   ```
   git log --follow --oneline -3 apps/frontend/package.json
   git log --follow --oneline -3 apps/backend/app/main.py
   ```

4. **.env resolution paths updated:**
   ```
   grep '../../.env' apps/backend/app/core/config.py
   grep 'envDir' apps/frontend/vite.config.ts
   ```

5. **No lingering old directories:**
   ```
   test ! -d frontend && test ! -d backend && echo "Clean"
   ```
</verification>

<success_criteria>
- Repo restructured to apps/frontend, apps/backend, apps/legacy, packages/ layout
- Root package.json declares workspaces and turbo scripts
- turbo.json has complete task pipeline with correct dependency graph
- .gitignore covers .turbo and node_modules
- Backend config.py reads .env from repo root
- Frontend vite.config.ts reads .env from repo root via envDir
- All changes are in a single atomic commit preserving git history
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-add-turbo/02.1-01-SUMMARY.md`
</output>

---
phase: 02.1-add-turbo
plan: 03
subsystem: infra
tags: [shared-types, json-schema, typescript-codegen, pydantic, monorepo, api-contracts]

# Dependency graph
requires:
  - phase: 02.1-add-turbo
    plan: 01
    provides: "Turborepo monorepo structure with packages/shared-types/ skeleton"
provides:
  - "packages/shared-types package.json (@indexcards/shared-types workspace package)"
  - "5 JSON Schema draft-07 files as single source of truth for API contracts"
  - "generate.mjs: custom codegen script (JSON Schema -> TypeScript interfaces)"
  - "generated/ts/index.ts: 11 TypeScript interfaces for all API types"
  - "bootstrap-schemas.py: one-time Pydantic-to-JSON-Schema extraction script"
affects:
  - "apps/frontend (can now import @indexcards/shared-types)"
  - "all future API changes (must flow through JSON Schema -> codegen)"
  - "02.1-04 (if exists) and subsequent phases using typed API contracts"

# Tech tracking
tech-stack:
  added:
    - "json-schema-to-typescript ^15.0.0 (devDependency in shared-types)"
    - "Custom JSON Schema -> TypeScript converter (generate.mjs)"
  patterns:
    - "JSON Schema draft-07 as cross-language source of truth for API contracts"
    - "definitions-based schema structure for $ref resolution across types"
    - "Generated TypeScript files committed to git (derived but stable artifacts)"
    - "Pydantic-to-JSON-Schema bootstrap via model_json_schema() + $defs rewriting"

key-files:
  created:
    - "packages/shared-types/package.json"
    - "packages/shared-types/tsconfig.json"
    - "packages/shared-types/schemas/batch.schema.json"
    - "packages/shared-types/schemas/health.schema.json"
    - "packages/shared-types/schemas/progress.schema.json"
    - "packages/shared-types/schemas/template.schema.json"
    - "packages/shared-types/schemas/upload.schema.json"
    - "packages/shared-types/scripts/bootstrap-schemas.py"
    - "packages/shared-types/scripts/generate.mjs"
    - "packages/shared-types/generated/ts/index.ts"

key-decisions:
  - "Custom TypeScript generator over json-schema-to-typescript to avoid duplicate helper type aliases"
  - "Merge all schema definitions before codegen to deduplicate cross-file types (ExtractionResult)"
  - "Generated files committed to git: frontend imports without running codegen first"
  - "Pydantic v2 $defs refs rewritten to draft-07 #/definitions refs in bootstrap script"
  - "json-schema-to-typescript kept as devDependency for future advanced use"

patterns-established:
  - "Pattern: JSON Schema files are source of truth — never edit generated/ts or generated/py directly"
  - "Pattern: bootstrap-schemas.py is one-time only; edit .schema.json for future changes"
  - "Pattern: generate.mjs merges all definitions then generates once (deduplication by design)"
  - "Pattern: turbo generate pipeline triggers npm run generate in packages/shared-types"

# Metrics
duration: 15min
completed: 2026-02-21
---

# Phase 02.1 Plan 03: Shared Types Package Summary

**JSON Schema source-of-truth for all API contracts with custom TypeScript codegen producing 11 clean interfaces from 5 domain schemas bootstrapped from existing Pydantic models.**

## Performance

- **Duration:** ~15 min
- **Started:** 2026-02-21T09:47:04Z
- **Completed:** 2026-02-21T10:02:00Z
- **Tasks:** 2
- **Files modified:** 10 created

## Accomplishments
- Created `packages/shared-types` workspace with `@indexcards/shared-types` package name
- Ran bootstrap script to extract 5 JSON Schema files from 12 existing Pydantic models
- Built custom codegen (generate.mjs) that merges all schemas and generates clean TypeScript
- Generated `index.ts` with 11 interfaces (ExtractionResult deduplicated across batch+progress schemas)
- Frontend can import `@indexcards/shared-types` via npm workspace resolution

## Task Commits

Each task was committed atomically:

1. **Task 1: Bootstrap JSON Schema from Pydantic models and create shared-types package** - `f1a6f70` (feat)
2. **Task 2: Create codegen scripts and generate initial TypeScript interfaces** - `0b918a3` (feat)

**Plan metadata:** (this commit)

## Files Created/Modified
- `packages/shared-types/package.json` - Workspace package: @indexcards/shared-types, exports generated/ts/index.ts
- `packages/shared-types/tsconfig.json` - TypeScript config for generated output, ESNext + bundler moduleResolution
- `packages/shared-types/schemas/health.schema.json` - HealthCheck interface schema
- `packages/shared-types/schemas/batch.schema.json` - BatchConfig, BatchCreate, BatchResponse, BatchHistory, ExtractionResult
- `packages/shared-types/schemas/upload.schema.json` - UploadResponse schema
- `packages/shared-types/schemas/template.schema.json` - Template, TemplateCreate, TemplateUpdate schemas
- `packages/shared-types/schemas/progress.schema.json` - BatchProgress schema (references ExtractionResult)
- `packages/shared-types/scripts/bootstrap-schemas.py` - One-time extraction script with $defs->definitions ref rewriting
- `packages/shared-types/scripts/generate.mjs` - Custom codegen: merges definitions, generates clean TypeScript interfaces
- `packages/shared-types/generated/ts/index.ts` - 11 TypeScript interfaces, committed artifact

## Decisions Made
- **Custom TypeScript generator:** `json-schema-to-typescript` produces redundant helper type aliases (e.g. `export type Fields = string[]`) that conflict when generating multiple interfaces. Wrote a custom `jsonSchemaTypeToTs()` converter that emits clean inline types directly. Package kept as devDependency.
- **Single-pass generation:** Merged all definitions from all schema files before generating, so cross-file $refs resolve and types like `ExtractionResult` are only emitted once.
- **Committed generated files:** Per plan spec, `generated/ts/index.ts` is committed so frontend can import without requiring a codegen step at install time.
- **$defs to definitions rewriting:** Pydantic v2 emits `$defs` and uses `#/$defs/` refs; JSON Schema draft-07 uses `definitions` and `#/definitions/`. Bootstrap script rewrites all refs during extraction.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed Pydantic v2 $defs ref in progress schema**
- **Found during:** Task 1 (Bootstrap run and schema inspection)
- **Issue:** `progress.schema.json` contained `"$ref": "#/$defs/ExtractionResult"` — a Pydantic v2 ref format incompatible with the draft-07 structure we produce (which uses `#/definitions/`)
- **Fix:** Rewrote the ref to `#/definitions/ExtractionResult` in the generated file; also updated bootstrap script to apply `fix_refs()` automatically for future runs
- **Files modified:** `packages/shared-types/schemas/progress.schema.json`, `scripts/bootstrap-schemas.py`
- **Committed in:** `f1a6f70` (Task 1 commit)

**2. [Rule 1 - Bug] Replaced json-schema-to-typescript with custom converter**
- **Found during:** Task 2 (TypeScript generation and output review)
- **Issue:** `json-schema-to-typescript` generated duplicate `export type` declarations (`Fields`, `Status`, `BatchName`, etc.) that would cause TypeScript compilation errors when multiple interfaces are compiled in sequence
- **Fix:** Wrote custom `jsonSchemaTypeToTs()` function in generate.mjs that translates JSON Schema properties to inline TypeScript types without helper aliases; produces valid compilable output
- **Files modified:** `packages/shared-types/scripts/generate.mjs`
- **Committed in:** `0b918a3` (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (both Rule 1 - bugs)
**Impact on plan:** Both fixes necessary for correctness. The custom converter produces cleaner output than the library would have. No scope creep.

## Issues Encountered
- `json-schema-to-typescript` version 15 generates per-definition helper type aliases that collide when iterating over multiple definitions. Three approaches were attempted (per-definition compilation, combined anyOf schema, post-processing deduplication) before writing the custom converter. The custom approach is simpler and produces better output.

## User Setup Required
None - no external service configuration required. Running `npm run generate` in `packages/shared-types` regenerates all types. Pydantic generation requires `datamodel-code-generator` (via `pip install datamodel-code-generator`), but is optional and skipped gracefully.

## Next Phase Readiness
- `@indexcards/shared-types` is importable from the frontend via workspace resolution
- `turbo generate` pipeline works (runs `npm run generate` in packages/shared-types)
- Future API changes: edit `.schema.json` files, run `npm run generate` (or `turbo generate`), commit updated `index.ts`
- Pydantic codegen path ready once `datamodel-code-generator` is installed in backend

---
*Phase: 02.1-add-turbo*
*Completed: 2026-02-21*

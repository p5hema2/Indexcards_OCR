---
phase: 02.1-add-turbo
plan: 01
subsystem: infra
tags: [turborepo, npm-workspaces, monorepo, turbo, vite, pydantic-settings, git-mv]

# Dependency graph
requires:
  - phase: 02-frontend-scaffold-configuration-react
    provides: "frontend React app (frontend/) and backend FastAPI app (backend/) in flat structure"
provides:
  - "apps/frontend/ with git history preserved (moved from frontend/)"
  - "apps/backend/ with git history preserved (moved from backend/)"
  - "apps/legacy/ with indexcard_ocr.py, config.py, requirements.txt, tests/"
  - "packages/shared-types/ skeleton"
  - "Root package.json with npm workspaces (apps/*, packages/*) and turbo scripts"
  - "turbo.json with full task pipeline (dev/build/test/lint/typecheck/format/clean/generate)"
  - ".gitignore updated with .turbo and node_modules/"
  - "apps/backend/app/core/config.py reads .env from repo root via tuple"
  - "apps/frontend/vite.config.ts reads .env from repo root via envDir"
affects:
  - "02.1-02 (backend package.json wrapper)"
  - "02.1-03 (packages/shared-types setup)"
  - "all subsequent phases (monorepo structure is foundational)"

# Tech tracking
tech-stack:
  added:
    - "turbo ^2.8.10 (root devDependency)"
    - "npm workspaces (built-in)"
  patterns:
    - "Turborepo apps/* + packages/* monorepo layout"
    - "Single root .env for both frontend and backend"
    - "pydantic-settings env_file tuple for fallback .env resolution"
    - "Vite envDir pointing to repo root via path.resolve(__dirname, '../..')"
    - "git mv for history-preserving directory migration"

key-files:
  created:
    - "package.json (root workspace orchestration)"
    - "turbo.json (full task pipeline)"
    - "apps/legacy/ (legacy OCR files)"
    - "packages/shared-types/ (skeleton)"
  modified:
    - "apps/backend/app/core/config.py (env_file tuple for root .env)"
    - "apps/frontend/vite.config.ts (envDir + path import)"
    - ".gitignore (.turbo and node_modules/ added)"

key-decisions:
  - "Single atomic commit for entire restructure (locked decision from CONTEXT.md)"
  - "turbo.json: typecheck before build, lint independent, test after build (locked)"
  - "turbo.json: local caching only, no remote cache (locked)"
  - "pydantic-settings: env_file tuple ('../../.env', '.env') - root first, local fallback"
  - "Vite: envDir path.resolve(__dirname, '../..') to reach repo root from apps/frontend/"
  - "output_batches moved with plain mv (git had no tracked files to rename)"

patterns-established:
  - "Pattern: All turbo tasks run from package directory (CWD = apps/frontend or apps/backend)"
  - "Pattern: Root .env is single source of truth for all env vars"
  - "Pattern: dev task has persistent:true and dependsOn:[] (never depended on)"

# Metrics
duration: 3min
completed: 2026-02-21
---

# Phase 02.1 Plan 01: Turborepo Monorepo Migration Summary

**Repo restructured from flat frontend/+backend/ to apps/+packages/ Turborepo layout with root npm workspaces, full turbo.json task pipeline, and .env path fixes for both apps using git mv for history preservation.**

## Performance

- **Duration:** ~3 min
- **Started:** 2026-02-21T09:42:23Z
- **Completed:** 2026-02-21T09:44:55Z
- **Tasks:** 3
- **Files modified:** 53 (51 renames, 2 created, 3 content-modified)

## Accomplishments
- Migrated `frontend/` and `backend/` to `apps/frontend/` and `apps/backend/` with full git history preserved via `git mv`
- Created root `package.json` with npm workspaces (`apps/*`, `packages/*`) and `turbo.json` with complete task pipeline
- Fixed `.env` resolution: backend uses pydantic-settings tuple `("../../.env", ".env")`, frontend uses Vite `envDir: path.resolve(__dirname, '../..')`
- Moved all legacy root-level Python files (`indexcard_ocr.py`, `config.py`, `requirements.txt`, `tests/`) to `apps/legacy/`

## Task Commits

Per the locked decision "Single atomic commit for the entire restructure," all 3 tasks were committed together:

1. **Task 1: Migrate directory structure with git mv** - included in `1847290`
2. **Task 2: Create root package.json, turbo.json, and update .gitignore** - included in `1847290`
3. **Task 3: Fix .env path resolution for backend and frontend** - included in `1847290`

**Single atomic commit:** `1847290` - `refactor(02.1-01): migrate to Turborepo monorepo (apps/ + packages/)`

## Files Created/Modified
- `package.json` - Root workspace orchestration; npm workspaces for apps/*, packages/*; turbo scripts
- `turbo.json` - Full task pipeline: dev (persistent), build (after typecheck), typecheck, test (after build), lint (independent), format, clean, generate
- `.gitignore` - Added `.turbo` and `node_modules/` entries
- `apps/frontend/vite.config.ts` - Added `import path from 'path'` and `envDir: path.resolve(__dirname, '../..')` to read root .env
- `apps/backend/app/core/config.py` - Changed `env_file = ".env"` to `env_file = ("../../.env", ".env")` for root .env resolution
- All files under `apps/frontend/` (moved from `frontend/`) - 39 files
- All files under `apps/backend/` (moved from `backend/`) - 14 files
- All files under `apps/legacy/` (moved from repo root) - 4 files

## Decisions Made
- Used `env_file = ("../../.env", ".env")` tuple in pydantic-settings — checks root first, falls back to local `.env`; keeps npm scripts clean
- Used `path.resolve(__dirname, '../..')` in Vite `envDir` — resolves to repo root from `apps/frontend/` at build time; `@types/node` already present in devDependencies
- `output_batches` moved with plain `mv` instead of `git mv` because git had no tracked files inside it (all contents were empty subdirs + empty log file)

## Deviations from Plan

None - plan executed exactly as written.

Minor implementation note: `output_batches/` had no git-tracked files so `git mv` failed with "source directory is empty." Used plain `mv` instead — no behavioral difference since there was no git history to preserve for that directory.

## Issues Encountered
- `git mv output_batches apps/legacy/` failed with "fatal: source directory is empty" — the directory existed on disk but had no tracked files (csv/, json/ subdirs were empty; vlm_pipeline.log was 0 bytes and untracked). Resolved by using plain `mv` instead. No impact since there was no git history to preserve.
- Old `frontend/` directory remained after `git mv` with a `.vite` cache directory (untracked). Removed with `rm -rf` before final verification.

## User Setup Required
None - no external service configuration required. The root `.env` file (not committed, gitignored) must exist at repo root for both apps to read `OPENROUTER_API_KEY`. See `.env.example` at root.

## Next Phase Readiness
- Monorepo structure is in place and committed
- `apps/backend/` needs a thin `package.json` wrapper so Turborepo can discover and run backend tasks — this is Plan 02 of Phase 02.1
- `packages/shared-types/` skeleton exists, needs `package.json` and codegen setup — this is Plan 03 of Phase 02.1
- `npm install` at repo root will install `turbo` devDependency; backend and legacy remain Python-only until Plan 02

---
*Phase: 02.1-add-turbo*
*Completed: 2026-02-21*

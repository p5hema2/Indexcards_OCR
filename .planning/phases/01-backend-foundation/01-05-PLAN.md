---
phase: 01-backend-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/api/templatesApi.ts
  - apps/frontend/src/features/configure/FieldManager.tsx
  - apps/frontend/src/features/configure/ConfigureStep.tsx
  - apps/frontend/src/features/configure/TemplateSelector.tsx
  - apps/frontend/src/features/configure/SaveTemplateDialog.tsx
  - apps/frontend/src/features/configure/ImagePreview.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can save current field configuration as a named template"
    - "User can delete a saved template from the dropdown"
    - "User sees the first uploaded image in the Configure step"
    - "User can hover over the image preview for a magnified view"
  artifacts:
    - path: "apps/frontend/src/api/templatesApi.ts"
      provides: "Template CRUD mutations"
      exports: ["useCreateTemplateMutation", "useDeleteTemplateMutation"]
    - path: "apps/frontend/src/features/configure/SaveTemplateDialog.tsx"
      provides: "Modal dialog for naming a new template"
      min_lines: 30
    - path: "apps/frontend/src/features/configure/ImagePreview.tsx"
      provides: "First-image preview with magnifier on hover"
      min_lines: 40
    - path: "apps/frontend/src/features/configure/FieldManager.tsx"
      provides: "Save as Template button"
      contains: "Save as Template"
    - path: "apps/frontend/src/features/configure/TemplateSelector.tsx"
      provides: "Delete button per template in dropdown"
      contains: "useDeleteTemplateMutation"
  key_links:
    - from: "apps/frontend/src/features/configure/FieldManager.tsx"
      to: "apps/frontend/src/api/templatesApi.ts"
      via: "useCreateTemplateMutation"
      pattern: "useCreateTemplateMutation"
    - from: "apps/frontend/src/features/configure/TemplateSelector.tsx"
      to: "apps/frontend/src/api/templatesApi.ts"
      via: "useDeleteTemplateMutation"
      pattern: "useDeleteTemplateMutation"
    - from: "apps/frontend/src/features/configure/ImagePreview.tsx"
      to: "Zustand store files array"
      via: "useWizardStore files[0]"
      pattern: "files\\[0\\]"
---

<objective>
Add template save/delete UI and image preview with magnifier to the Configure step.

Purpose: The backend has full template CRUD (POST/GET/PUT/DELETE /api/v1/templates) but the frontend only reads templates. Users cannot save their custom field configurations for reuse. Additionally, the user requested seeing the first batch image in the Configure step with a magnifier on hover so they can read the index card while defining fields.

Output: Save as Template button with name dialog, delete button on templates, image preview with hover magnifier.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-UAT.md
@apps/frontend/src/api/templatesApi.ts
@apps/frontend/src/features/configure/FieldManager.tsx
@apps/frontend/src/features/configure/TemplateSelector.tsx
@apps/frontend/src/features/configure/ConfigureStep.tsx
@apps/frontend/src/store/wizardStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template mutations and Save/Delete UI</name>
  <files>
    apps/frontend/src/api/templatesApi.ts
    apps/frontend/src/features/configure/SaveTemplateDialog.tsx
    apps/frontend/src/features/configure/FieldManager.tsx
    apps/frontend/src/features/configure/TemplateSelector.tsx
  </files>
  <action>
1. **templatesApi.ts** -- Add three mutation hooks alongside the existing useTemplatesQuery:

   - `useCreateTemplateMutation()`: POST /api/v1/templates/ with body `{ name: string, fields: string[] }`.
     On success, toast "Template saved" and invalidate queryKey ['templates'].
     Uses `useQueryClient()` from @tanstack/react-query to call `queryClient.invalidateQueries({ queryKey: ['templates'] })`.

   - `useUpdateTemplateMutation()`: PUT /api/v1/templates/{id} with body `{ name?: string, fields?: string[] }`.
     On success, invalidate ['templates']. (Wired for future use but not surfaced in UI yet.)

   - `useDeleteTemplateMutation()`: DELETE /api/v1/templates/{id}.
     On success, toast "Template deleted" and invalidate ['templates'].

   All error handlers follow existing pattern: extract `error.response?.data?.detail` or fallback message.

2. **SaveTemplateDialog.tsx** -- Create a new component: a simple modal overlay dialog.
   Props: `isOpen: boolean`, `onClose: () => void`, `onSave: (name: string) => void`.
   Contains: text input for template name, Save and Cancel buttons.
   Style: Use the existing parchment theme classes (bg-parchment-light, border-parchment-dark, font-serif, text-archive-ink). Modal backdrop with bg-black/30. Center the dialog with fixed inset-0 flex items-center justify-center.
   Validate: name must be non-empty and trimmed before calling onSave.

3. **FieldManager.tsx** -- Add a "Save as Template" button below the field list (after the info box, or next to it).
   - Import `useCreateTemplateMutation` from templatesApi and `SaveTemplateDialog`.
   - Add `showSaveDialog` state (boolean).
   - The button: icon `Save` from lucide-react, text "Save as Template", disabled when fields.length === 0.
   - Style: secondary button style -- border border-archive-sepia/30 text-archive-sepia hover:bg-archive-sepia/10 rounded px-4 py-2.
   - On click: set showSaveDialog to true.
   - On dialog save: call `createTemplateMutation.mutate({ name, fields: fields.map(f => f.label) })`, then close dialog.
   - Render `<SaveTemplateDialog isOpen={showSaveDialog} onClose={...} onSave={...} />`.

4. **TemplateSelector.tsx** -- Add a delete button (small X or Trash icon) next to each template in the dropdown.
   Since HTML `<select>` does not support custom markup inside `<option>`, refactor the template list from a `<select>` to a custom dropdown or a simple list of template items:
   - Replace the `<select>` with a div-based list of template buttons.
   - Each template row: click to apply (existing behavior), plus a small Trash2 icon button on the right to delete.
   - Keep the "Custom / Blank Slate" option at top (no delete button).
   - Use `useDeleteTemplateMutation` from templatesApi.
   - On delete click: e.stopPropagation() to prevent applying the template, then call mutation.
   - Invalidation is handled by the mutation hook -- the list will auto-refresh.
   - Style: Use same parchment theme. Each row: flex items-center justify-between px-4 py-2 hover:bg-parchment-dark/10 rounded cursor-pointer. The delete button: p-1 text-archive-ink/30 hover:text-red-600.
  </action>
  <verify>
`cd apps/frontend && npx tsc --noEmit` passes. Visually confirm: SaveTemplateDialog renders when "Save as Template" is clicked, TemplateSelector shows delete buttons.
  </verify>
  <done>
Users can save current fields as a named template (POST /api/v1/templates). Users can delete templates from the selector (DELETE /api/v1/templates/{id}). Template list auto-refreshes after save or delete via query invalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add first-image preview with hover magnifier to Configure step</name>
  <files>
    apps/frontend/src/features/configure/ImagePreview.tsx
    apps/frontend/src/features/configure/ConfigureStep.tsx
  </files>
  <action>
1. **ImagePreview.tsx** -- Create a component that shows the first uploaded image as a preview.
   - Props: `sessionId: string | null` (to construct the image URL) OR directly use the first file from Zustand store.
   - The uploaded files are in `data/temp/{sessionId}/` on the backend, served via `/batches-static` only for permanent batches. Since temp files are NOT served by StaticFiles, use a different approach:
     The UploadedFile in Zustand has a `preview` field (from URL.createObjectURL during upload). Use `files[0].preview` as the image src. If preview is undefined (e.g., after page refresh/hydration where blob URLs are lost), show a placeholder "Image preview unavailable" text.
   - Layout: A card with the image, max-h-[300px], object-contain, rounded, parchment border.
   - **Magnifier on hover**: Use pure CSS/JS approach -- no external library needed.
     On mouseMove over the image, show a magnifier circle (150x150px div with overflow:hidden and a scaled copy of the image positioned based on cursor).
     Implementation: Use a ref on the image container. On mouseMove, calculate relative position and update a state `{ x, y, visible }`. Render a `div` with `position:absolute`, `border-radius:50%`, `border`, `pointer-events-none`, `overflow:hidden`, containing an `<img>` with `transform: scale(2.5)` and `transform-origin` set to the cursor-relative position.
     On mouseLeave, hide the magnifier.
   - Label above: "Sample Card Preview" in the same uppercase tracking-widest style.

2. **ConfigureStep.tsx** -- Add the ImagePreview component to the left sidebar panel (the lg:col-span-4 div), below the Batch Summary section but above the info box.
   - Import ImagePreview.
   - Render `<ImagePreview />` inside the sidebar. It reads files from Zustand directly, so no props needed (or pass files[0] as prop for cleaner separation).
   - Only render if files.length > 0.
  </action>
  <verify>
`cd apps/frontend && npx tsc --noEmit` passes. With the dev server running and images uploaded, the Configure step shows the first image with a magnifier lens on hover.
  </verify>
  <done>
First batch image visible in Configure step. Hovering over the image shows a magnified circular lens that follows the cursor, allowing users to read handwritten text on index cards while defining extraction fields.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in apps/frontend
- Save as Template button appears when fields are defined
- Clicking Save as Template opens a name dialog
- TemplateSelector shows delete buttons per template
- Image preview renders first uploaded file in Configure step sidebar
- Magnifier circle follows cursor on hover over preview image
</verification>

<success_criteria>
UAT test 4 (Template CRUD from frontend) passes -- users can create and delete templates through the UI. Image preview with magnifier is available in the Configure step for reading index cards while defining fields.
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-05-SUMMARY.md`
</output>

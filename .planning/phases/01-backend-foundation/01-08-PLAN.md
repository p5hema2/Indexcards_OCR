---
phase: 01-backend-foundation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/app/services/batch_manager.py
  - apps/backend/app/api/api_v1/endpoints/upload.py
  - apps/backend/app/main.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Temp session directories older than 24 hours are cleaned up on server startup"
    - "DELETE /api/v1/upload/{session_id} removes a temp session directory"
    - "Server does not accumulate orphaned temp files from abandoned upload sessions"
  artifacts:
    - path: "apps/backend/app/services/batch_manager.py"
      provides: "cleanup_stale_sessions method"
      contains: "cleanup_stale_sessions"
    - path: "apps/backend/app/api/api_v1/endpoints/upload.py"
      provides: "DELETE endpoint for temp session cleanup"
      contains: "@router.delete"
    - path: "apps/backend/app/main.py"
      provides: "Startup event that triggers temp cleanup"
      contains: "cleanup_stale_sessions"
  key_links:
    - from: "apps/backend/app/main.py:startup"
      to: "apps/backend/app/services/batch_manager.py:cleanup_stale_sessions"
      via: "FastAPI lifespan or startup event"
      pattern: "cleanup_stale_sessions"
    - from: "apps/backend/app/api/api_v1/endpoints/upload.py:DELETE"
      to: "apps/backend/app/services/batch_manager.py:delete_session"
      via: "batch_manager.delete_session(session_id)"
      pattern: "delete_session"
---

<objective>
Prevent temp file pollution by adding session cleanup mechanisms.

Purpose: UAT test 3 (major) â€” when users upload files but never create a batch (navigate away, close browser), orphaned temp session directories accumulate in data/temp/. This plan adds: (1) a startup cleanup that removes temp sessions older than 24 hours, (2) a DELETE endpoint for explicit temp session removal, so the frontend can clean up when the user navigates away from the upload step.

Output: No orphaned temp files accumulate on the server.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add temp session cleanup to batch_manager and upload endpoint</name>
  <files>
    apps/backend/app/services/batch_manager.py
    apps/backend/app/api/api_v1/endpoints/upload.py
  </files>
  <action>
1. In `batch_manager.py`, add two new methods to the BatchManager class:

   a. `cleanup_stale_sessions(self, max_age_hours: int = 24)`:
      - Iterates over directories in `self.temp_dir`
      - For each directory, checks its modification time (`stat().st_mtime`)
      - If older than `max_age_hours`, removes it with `shutil.rmtree()`
      - Logs the count of cleaned-up sessions
      - Returns the count

   b. `delete_session(self, session_id: str) -> bool`:
      - Constructs the session path: `self.temp_dir / session_id`
      - If it exists, removes it with `shutil.rmtree()` and returns True
      - Otherwise returns False

   Add `import time` at the top if not already present.

2. In `upload.py`, add a DELETE endpoint:
   ```python
   @router.delete("/{session_id}", status_code=204)
   async def delete_session(session_id: str):
       """Delete a temp upload session and its files."""
       deleted = batch_manager.delete_session(session_id)
       if not deleted:
           raise HTTPException(status_code=404, detail=f"Session '{session_id}' not found")
       return None
   ```

   Add `HTTPException` to the import from fastapi if not already there.
  </action>
  <verify>
1. Read batch_manager.py and confirm `cleanup_stale_sessions` and `delete_session` methods exist.
2. Read upload.py and confirm DELETE endpoint exists with 204 status.
  </verify>
  <done>
BatchManager has cleanup and delete methods. Upload router has DELETE endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire startup cleanup in main.py</name>
  <files>
    apps/backend/app/main.py
  </files>
  <action>
In `main.py`, add a startup handler that calls `batch_manager.cleanup_stale_sessions()`:

If the app uses a lifespan context manager:
```python
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup: clean orphaned temp sessions
    from app.services.batch_manager import batch_manager
    cleaned = batch_manager.cleanup_stale_sessions()
    if cleaned > 0:
        logger.info(f"Cleaned up {cleaned} stale temp session(s)")
    yield
    # Shutdown: nothing needed

app = FastAPI(..., lifespan=lifespan)
```

If the app uses `@app.on_event("startup")` instead:
```python
@app.on_event("startup")
async def startup_event():
    from app.services.batch_manager import batch_manager
    cleaned = batch_manager.cleanup_stale_sessions()
    if cleaned > 0:
        logger.info(f"Cleaned up {cleaned} stale temp session(s)")
```

Use whichever pattern the existing main.py already uses. If neither exists, use the lifespan approach (modern FastAPI).
  </action>
  <verify>
1. Read main.py and confirm the startup cleanup is wired.
2. Confirm the import path for batch_manager is correct.
  </verify>
  <done>
Server cleans up stale temp sessions on every startup.
  </done>
</task>

</tasks>

<verification>
- batch_manager.py has `cleanup_stale_sessions()` method that removes dirs older than 24h from temp_dir
- batch_manager.py has `delete_session()` method that removes a specific session directory
- upload.py has `DELETE /{session_id}` endpoint returning 204
- main.py calls `batch_manager.cleanup_stale_sessions()` at startup
</verification>

<success_criteria>
UAT test 3 (temp file pollution) addressed: orphaned temp sessions are cleaned up on server startup. Explicit DELETE endpoint available for frontend cleanup on navigation away.
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-08-SUMMARY.md`
</output>

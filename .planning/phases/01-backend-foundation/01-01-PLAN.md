---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/core/config.py
  - backend/app/models/schemas.py
  - backend/app/services/ocr_engine.py
  - backend/requirements.txt
autonomous: true
requirements: [BACKEND-01, BACKEND-02]

must_haves:
  truths:
    - "Backend starts and responds to health check at /api/v1/health"
    - "OcrEngine class can be instantiated and its process method can be called"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application entry point"
    - path: "backend/app/services/ocr_engine.py"
      provides: "Modularized OCR logic as a class"
    - path: "backend/app/core/config.py"
      provides: "Pydantic-based settings management"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/services/ocr_engine.py"
      via: "Dependency injection or instantiation"
---

<objective>
Initialize the FastAPI project structure and refactor the existing procedural OCR script into a modular, thread-aware service class.

Purpose: To transition from a CLI-based script to a robust, reactive backend foundation.
Output: A working FastAPI application with a modularized OCR engine ready for API integration.
</objective>

<execution_context>
@/Users/martinhess/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/1-CONTEXT.md
@.planning/phases/01-backend-foundation/1-RESEARCH.md
@indexcard_ocr.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize FastAPI project structure</name>
  <files>
    - backend/requirements.txt
    - backend/app/main.py
    - backend/app/core/config.py
    - backend/app/models/schemas.py
    - backend/app/api/api_v1/api.py
    - backend/app/api/api_v1/endpoints/health.py
  </files>
  <action>
    Set up the basic FastAPI structure as recommended in RESEARCH.md.
    - Create `backend/requirements.txt` with fastapi, uvicorn, pydantic-settings, python-dotenv, requests, pandas, pillow.
    - Implement `backend/app/core/config.py` using Pydantic `BaseSettings`, migrating values from the original `config.py`.
    - Create `backend/app/main.py` with a basic router and a health check endpoint at `/api/v1/health`.
    - Set up directory structure for `data/temp` and `data/batches`.
  </action>
  <verify>
    Run `uvicorn app.main:app --reload` in `backend/` and check `curl http://localhost:8000/api/v1/health` returns 200 OK.
  </verify>
  <done>
    FastAPI app is running and directory structure is initialized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor OCR script into modular OcrEngine service</name>
  <files>
    - backend/app/services/ocr_engine.py
  </files>
  <action>
    Transform `indexcard_ocr.py` into a modular `OcrEngine` class in `backend/app/services/ocr_engine.py`.
    - The class should handle its own `requests.Session`.
    - Encapsulate `call_vlm_api_resilient`, `encode_image_to_base64`, and `validate_extraction`.
    - Implement a `process_card` and `process_batch` method that is thread-safe.
    - Use `asyncio.to_thread` or `run_in_executor` to ensure it doesn't block the FastAPI event loop.
    - Add a placeholder for a progress callback function that will later be used by the WebSocket manager.
    - Ensure it uses the new `Settings` from `core/config.py`.
  </action>
  <verify>
    Create a temporary test script in `backend/` that instantiates `OcrEngine` and calls `process_card` on a sample image from `input_batches`.
  </verify>
  <done>
    `OcrEngine` class is functional and decoupled from CLI logic.
  </done>
</task>

</tasks>

<verification>
Check that the backend starts without errors and the OCR engine can be successfully imported and used in a standalone script.
</verification>

<success_criteria>
- FastAPI server responds to health check.
- `OcrEngine` successfully processes a single card using the OpenRouter API.
- Project structure follows the design in RESEARCH.md.
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>

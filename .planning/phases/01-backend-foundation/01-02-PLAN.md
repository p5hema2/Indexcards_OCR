---
phase: 01-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - backend/app/api/api_v1/endpoints/upload.py
  - backend/app/api/api_v1/endpoints/batches.py
  - backend/app/services/batch_manager.py
  - backend/app/services/template_service.py
  - backend/data/templates.json
autonomous: true
requirements: [BACKEND-03, BACKEND-04, BACKEND-07]

must_haves:
  truths:
    - "User can upload multiple images to a temporary session"
    - "A batch can be created with a custom name and a list of fields"
    - "Field templates can be saved and retrieved as reusable objects"
  artifacts:
    - path: "backend/app/services/batch_manager.py"
      provides: "File lifecycle (temp-to-perm) and batch naming"
    - path: "backend/app/services/template_service.py"
      provides: "CRUD for field configuration templates"
    - path: "backend/data/templates.json"
      provides: "Storage for reusable templates"
  key_links:
    - from: "backend/app/api/api_v1/endpoints/batches.py"
      to: "backend/app/services/batch_manager.py"
      via: "Method calls for batch creation"
---

<objective>
Implement the batch management lifecycle including file uploads, temp-to-perm moves, and field template management.

Purpose: To provide the user with a way to organize their OCR jobs and reuse configurations.
Output: Working Upload and Batch APIs with persistent template storage.
</objective>

<execution_context>
@/Users/martinhess/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/1-CONTEXT.md
@.planning/phases/01-backend-foundation/1-RESEARCH.md
@.planning/phases/01-backend-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BatchManager and Upload API</name>
  <files>
    - backend/app/services/batch_manager.py
    - backend/app/api/api_v1/endpoints/upload.py
    - backend/app/api/api_v1/endpoints/batches.py
  </files>
  <action>
    Implement the `BatchManager` to handle file operations and batch state.
    - Create `POST /api/v1/upload` which stores files in `data/temp/{session_id}`.
    - Implement `BatchManager.create_batch` that moves files from `temp` to `data/batches/{batch_name}_{timestamp}_{id}`.
    - Implement `POST /api/v1/batches` to create a new batch, lock it, and initialize its state.
    - Ensure naming convention from CONTEXT.md is followed: `[Custom Name]_[Human Readable Timestamp]_[Unique ID]`.
  </action>
  <verify>
    Use `curl` or a Python script to upload 2-3 images to `/api/v1/upload`, then call `/api/v1/batches` with a custom name and verify the files moved to the permanent directory.
  </verify>
  <done>
    Upload and Batch creation flow is functional and follows naming rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Template Service and History</name>
  <files>
    - backend/app/services/template_service.py
    - backend/app/api/api_v1/endpoints/templates.py
    - backend/data/templates.json
  </files>
  <action>
    Create a `TemplateService` to manage reusable field configurations.
    - Implement CRUD endpoints for `/api/v1/templates` stored in `backend/data/templates.json`.
    - Each template should contain a list of fields and a descriptive name.
    - Update `BatchManager` to record batch history in a `batches.json` or similar simple storage to track status (e.g., 'uploaded', 'processing', 'completed').
  </action>
  <verify>
    Create a template via POST, list templates via GET, and verify the JSON file content.
  </verify>
  <done>
    Field templates and batch history are persisted and accessible via API.
  </done>
</task>

</tasks>

<verification>
Verify that an upload followed by batch creation results in the correct folder structure and that templates can be successfully saved and retrieved.
</verification>

<success_criteria>
- Batch folders follow the specified naming convention.
- Files are correctly moved from temp to permanent storage.
- Field configurations are persistent and reusable as templates.
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-02-SUMMARY.md`
</output>

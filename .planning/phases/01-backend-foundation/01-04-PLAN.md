---
phase: 01-backend-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/app/api/api_v1/endpoints/health.py
  - apps/frontend/vite.config.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "GET /api/v1/health returns 200 OK with JSON body containing status and version"
    - "WebSocket connections to ws://localhost:5173/api/v1/ws/task/{id} are proxied to backend port 8000"
  artifacts:
    - path: "apps/backend/app/api/api_v1/endpoints/health.py"
      provides: "Health endpoint at correct route"
      contains: '@router.get("/"'
    - path: "apps/frontend/vite.config.ts"
      provides: "Vite proxy with working WS forwarding"
      contains: "rewriteWsOrigin"
  key_links:
    - from: "apps/frontend (any HTTP client)"
      to: "apps/backend/app/api/api_v1/endpoints/health.py"
      via: "Vite proxy /api -> http://localhost:8000"
      pattern: "/api/v1/health"
    - from: "apps/frontend/src/features/processing/useProcessingWebSocket.ts"
      to: "apps/backend/app/api/api_v1/endpoints/ws.py"
      via: "Vite proxy WS upgrade /api -> http://localhost:8000"
      pattern: "ws.*true.*rewriteWsOrigin"
---

<objective>
Fix the health endpoint double-prefix bug and the WebSocket proxy failure.

Purpose: These two infrastructure bugs block UAT tests 1, 5, 6, and 7. The health endpoint returns 404 because api.py mounts health.router at prefix="/health" but the route itself also declares "/health", creating /api/v1/health/health. The WebSocket proxy in Vite 7 (which uses http-proxy-3) requires rewriteWsOrigin:true for WS upgrade origin rewriting -- without it, the backend rejects or never receives the upgrade.

Output: Working health endpoint and functional WebSocket proxy.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix health endpoint double prefix and WebSocket proxy</name>
  <files>
    apps/backend/app/api/api_v1/endpoints/health.py
    apps/frontend/vite.config.ts
  </files>
  <action>
1. In apps/backend/app/api/api_v1/endpoints/health.py, change the route decorator from
   `@router.get("/health", response_model=HealthCheck)` to `@router.get("/", response_model=HealthCheck)`.
   The router is already mounted at prefix="/health" in api.py, so the final path will be /api/v1/health.

2. In apps/frontend/vite.config.ts, add `rewriteWsOrigin: true` to the /api proxy entry.
   Vite 7 uses http-proxy-3 which requires explicit WS origin rewriting for WebSocket upgrade
   requests. Without it, the origin header is not rewritten during WS handshake even though
   changeOrigin:true handles HTTP requests. The final proxy config should be:
   ```
   '/api': {
     target: 'http://localhost:8000',
     changeOrigin: true,
     ws: true,
     rewriteWsOrigin: true,
   },
   ```
  </action>
  <verify>
1. Start the backend: `cd apps/backend && uv run uvicorn app.main:app --port 8000`
2. `curl http://localhost:8000/api/v1/health` returns 200 with `{"status":"OK","version":"0.1.0"}`
3. TypeScript check: `cd apps/frontend && npx tsc --noEmit` passes (vite.config.ts is valid)
  </verify>
  <done>
Health endpoint returns 200 at /api/v1/health (not 404). Vite config includes rewriteWsOrigin:true for WS proxy forwarding.
  </done>
</task>

</tasks>

<verification>
- `curl http://localhost:8000/api/v1/health` returns `{"status":"OK","version":"0.1.0"}`
- `curl http://localhost:8000/api/v1/health/health` returns 404 (confirming the old double-prefix path no longer exists)
- vite.config.ts contains `rewriteWsOrigin: true` in the /api proxy block
</verification>

<success_criteria>
UAT test 1 (health check) passes. WebSocket proxy configuration is correct for Vite 7 / http-proxy-3 (UAT test 5 unblocked -- full WS verification requires running OCR which needs the frontend running).
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-04-SUMMARY.md`
</output>

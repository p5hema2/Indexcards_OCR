---
phase: 01-backend-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/app/api/api_v1/endpoints/batches.py
  - apps/backend/app/models/schemas.py
  - apps/frontend/src/api/batchesApi.ts
  - apps/frontend/src/features/history/BatchHistoryDashboard.tsx
  - apps/frontend/src/features/history/BatchHistoryCard.tsx
  - apps/frontend/src/store/wizardStore.ts
  - apps/frontend/src/App.tsx
  - apps/frontend/src/components/Sidebar.tsx
  - apps/frontend/src/components/Header.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can navigate to a batch history dashboard from the main app"
    - "Dashboard shows all past batches with name, date, file count, and status"
    - "User can delete a batch from the dashboard"
    - "User can review results of a completed batch from the dashboard"
    - "User can retry a failed batch from the dashboard"
  artifacts:
    - path: "apps/backend/app/api/api_v1/endpoints/batches.py"
      provides: "GET /history and DELETE /{batch_name} endpoints"
      contains: "def get_batch_history"
    - path: "apps/backend/app/models/schemas.py"
      provides: "BatchHistoryItem response model"
      contains: "class BatchHistoryItem"
    - path: "apps/frontend/src/api/batchesApi.ts"
      provides: "useBatchHistoryQuery and useDeleteBatchMutation hooks"
      exports: ["useBatchHistoryQuery", "useDeleteBatchMutation"]
    - path: "apps/frontend/src/features/history/BatchHistoryDashboard.tsx"
      provides: "Dashboard component listing all batches"
      min_lines: 50
    - path: "apps/frontend/src/features/history/BatchHistoryCard.tsx"
      provides: "Individual batch card with actions"
      min_lines: 40
    - path: "apps/frontend/src/App.tsx"
      provides: "Routing between wizard and history views"
      contains: "history"
    - path: "apps/frontend/src/store/wizardStore.ts"
      provides: "view state for wizard vs history"
      contains: "history"
  key_links:
    - from: "apps/frontend/src/features/history/BatchHistoryDashboard.tsx"
      to: "/api/v1/batches/history"
      via: "useBatchHistoryQuery"
      pattern: "useBatchHistoryQuery"
    - from: "apps/frontend/src/features/history/BatchHistoryCard.tsx"
      to: "/api/v1/batches/{name}"
      via: "useDeleteBatchMutation"
      pattern: "useDeleteBatchMutation"
    - from: "apps/frontend/src/App.tsx"
      to: "apps/frontend/src/features/history/BatchHistoryDashboard.tsx"
      via: "view state in Zustand"
      pattern: "view.*===.*'history'"
---

<objective>
Build batch history backend endpoints and a frontend dashboard for browsing, deleting, retrying, and reviewing past batches.

Purpose: The backend persists batch metadata in batches.json but has no endpoint to return full history (only batch names). The frontend has no UI to browse past runs. Users need to review results from completed batches, retry failed ones, and delete old batches without accessing the file system.

Output: GET /api/v1/batches/history endpoint, DELETE /api/v1/batches/{name} endpoint, and a BatchHistoryDashboard React component with per-batch action buttons.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-UAT.md
@apps/backend/app/api/api_v1/endpoints/batches.py
@apps/backend/app/models/schemas.py
@apps/backend/app/services/batch_manager.py
@apps/frontend/src/api/batchesApi.ts
@apps/frontend/src/store/wizardStore.ts
@apps/frontend/src/App.tsx
@apps/frontend/src/components/Sidebar.tsx
@apps/frontend/src/components/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch history and delete endpoints to backend</name>
  <files>
    apps/backend/app/api/api_v1/endpoints/batches.py
    apps/backend/app/models/schemas.py
    apps/backend/app/services/batch_manager.py
  </files>
  <action>
1. **schemas.py** -- Add a new response model `BatchHistoryItem`:
   ```python
   class BatchHistoryItem(BaseModel):
       batch_name: str
       custom_name: str
       created_at: str
       status: str
       files_count: int
       fields: List[str]
       has_errors: bool = False
       error_count: int = 0
   ```
   Note: The existing `BatchHistory` model is close but lacks `custom_name`, `has_errors`, and `error_count`. Create the new model rather than modifying the unused one, to avoid confusion. Optionally remove the unused `BatchHistory` class.

2. **batch_manager.py** -- Add two methods:

   - `get_history(self) -> list[dict]`: Read batches.json (at settings.BATCHES_HISTORY_FILE), return the full list. For each entry, enrich with:
     - `files_count`: count image files (.jpg/.jpeg/.png/.tiff/.tif) in the batch directory (if it still exists, else use the stored value)
     - `has_errors`: check if batch_path / "_errors" exists and has files
     - `error_count`: count files in _errors/ if it exists, else 0
     If batches.json doesn't exist or is empty, return [].

   - `delete_batch(self, batch_name: str) -> bool`: Delete the batch directory (shutil.rmtree) and remove the entry from batches.json. Return True if found and deleted, False otherwise.

3. **batches.py** -- Add two new endpoints:

   - `GET /history` -- Returns List[BatchHistoryItem] from batch_manager.get_history(). Place this route BEFORE the `/{batch_name}` routes to avoid FastAPI treating "history" as a batch_name parameter.

   - `DELETE /{batch_name}` -- Calls batch_manager.delete_batch(batch_name). Returns 204 on success, 404 if batch not found.

   Route ordering matters: place `@router.get("/history")` above `@router.post("/{batch_name}/start")` in the file. FastAPI matches routes top-down for path parameters.
  </action>
  <verify>
Start backend: `cd apps/backend && uv run uvicorn app.main:app --port 8000`
- `curl http://localhost:8000/api/v1/batches/history` returns 200 with JSON array (may be empty if no batches exist)
- `curl -X DELETE http://localhost:8000/api/v1/batches/nonexistent` returns 404
  </verify>
  <done>
GET /api/v1/batches/history returns full batch metadata from batches.json with live error counts. DELETE /api/v1/batches/{name} removes batch directory and history entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build BatchHistoryDashboard and wire into app navigation</name>
  <files>
    apps/frontend/src/api/batchesApi.ts
    apps/frontend/src/features/history/BatchHistoryDashboard.tsx
    apps/frontend/src/features/history/BatchHistoryCard.tsx
    apps/frontend/src/store/wizardStore.ts
    apps/frontend/src/App.tsx
    apps/frontend/src/components/Sidebar.tsx
    apps/frontend/src/components/Header.tsx
  </files>
  <action>
1. **batchesApi.ts** -- Add new hooks:

   - `BatchHistoryItem` interface matching the backend schema: `{ batch_name, custom_name, created_at, status, files_count, fields, has_errors, error_count }`.

   - `useBatchHistoryQuery()`: GET /api/v1/batches/history, queryKey: ['batch-history']. Returns `BatchHistoryItem[]`.

   - `useDeleteBatchMutation()`: DELETE /api/v1/batches/{batch_name}. On success: toast "Batch deleted", invalidate ['batch-history']. On error: extract detail message.

2. **wizardStore.ts** -- Add a `view` state to distinguish between wizard and history:

   - Add type: `type AppView = 'wizard' | 'history';`
   - Add to state: `view: AppView` (default: 'wizard')
   - Add action: `setView: (view: AppView) => void`
   - Add to initialState: `view: 'wizard' as AppView`
   - Add to persist partialize: include `view` so it survives refresh

   Also add a helper action `loadBatchForReview(batchName: string)`:
   - Sets batchId to batchName
   - Sets step to 'results'
   - Sets view to 'wizard'
   This allows the history dashboard to navigate to the results view for a specific batch.

3. **BatchHistoryCard.tsx** -- Create a card component for a single batch entry:
   Props: `batch: BatchHistoryItem`
   Layout: A parchment-themed card (bg-parchment-light/30, border border-parchment-dark/50, rounded-lg, p-5).
   Content:
   - Top row: custom_name (font-serif text-lg) + status badge (colored pill: green for "completed"/"uploaded", yellow for "running", red for "failed"/"cancelled"). Use the same statusStyles pattern from ResultsStep.
   - Details row: created_at formatted (new Date(batch.created_at).toLocaleDateString()), files_count + " files", fields.length + " fields".
   - If has_errors: show "X errors" in red text.
   - Bottom row: Action buttons:
     - "Review Results" (Eye icon) -- only if status is "completed" or has checkpoint data. Calls `loadBatchForReview(batch.batch_name)`.
     - "Retry" (RotateCcw icon) -- only if has_errors is true. Calls retryBatch(batch.batch_name), then navigates to processing step (setStep('processing'), setBatchId(batch.batch_name), setView('wizard')).
     - "Delete" (Trash2 icon) -- always visible. Calls useDeleteBatchMutation. Confirm with sonner toast action pattern (matching the existing deleteField pattern in FieldManager.tsx).
   - Button styles: small, icon + text, border-based, hover states matching parchment theme.

4. **BatchHistoryDashboard.tsx** -- Main dashboard view:
   - Uses useBatchHistoryQuery() to fetch data.
   - Header: "Batch Archive" (h2, font-serif, text-archive-sepia) with subtitle.
   - Loading state: Loader2 spinner (matching existing pattern).
   - Empty state: centered message "No batches in the archive yet."
   - Grid of BatchHistoryCard components: `grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4`.
   - "New Batch" button in header area: navigates back to wizard (setView('wizard'), resetWizard()).
   - Sort batches by created_at descending (newest first).

5. **App.tsx** -- Add view-level routing:
   - Import BatchHistoryDashboard and read `view` from wizardStore.
   - If view === 'history', render `<BatchHistoryDashboard />` instead of the wizard step.
   - If view === 'wizard', render the existing step switch (unchanged).
   - Both are wrapped in MainLayout.

6. **Sidebar.tsx** -- Add a "Batch Archive" link at the bottom of the sidebar (above the footer text):
   - Import `useWizardStore` (already imported) and use `setView`.
   - Add a clickable row with BookOpen or Archive icon from lucide-react, label "Batch Archive".
   - Style: similar to step items but with a divider above it. Active when view === 'history'.
   - On click: `setView('history')`.
   - Also add a "New Batch" link that does `setView('wizard')` + `resetWizard()`.

7. **Header.tsx** -- Add a small "Archive" button next to "Start Fresh":
   - Import `useWizardStore` and read view, setView.
   - If view === 'wizard': show "Batch Archive" button (BookOpen icon) that sets view to 'history'.
   - If view === 'history': show "New Batch" button (Plus icon) that sets view to 'wizard' and resets wizard.
   - This gives quick access from the header in addition to the sidebar.
  </action>
  <verify>
`cd apps/frontend && npx tsc --noEmit` passes. With dev server running:
- Clicking "Batch Archive" in sidebar or header shows the dashboard
- Dashboard loads batch history from backend API
- "New Batch" returns to the wizard
  </verify>
  <done>
Batch history dashboard is accessible from sidebar and header. Shows all past batches with metadata and status. Users can review results (navigates to ResultsStep for that batch), retry failed batches (navigates to ProcessingStep), and delete batches (removes from disk and history). Navigation between wizard and history views works bidirectionally.
  </done>
</task>

</tasks>

<verification>
- Backend: `curl /api/v1/batches/history` returns batch list with metadata
- Backend: `curl -X DELETE /api/v1/batches/{name}` deletes batch
- Frontend: `npx tsc --noEmit` passes
- Dashboard renders in the app when "Batch Archive" is clicked
- Batch cards show status, date, file count, error count
- Review navigates to ResultsStep for the selected batch
- Delete removes batch from dashboard after confirmation
- New Batch returns to upload wizard
</verification>

<success_criteria>
UAT test 8 (batch history browsable from frontend) passes. Users can navigate to a dashboard, see all past batches with full metadata, review results of completed batches, retry failed batches, and delete unwanted batches.
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-06-SUMMARY.md`
</output>

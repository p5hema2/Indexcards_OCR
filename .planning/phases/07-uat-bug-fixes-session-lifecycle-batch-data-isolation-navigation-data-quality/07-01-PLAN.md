---
phase: 07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/features/results/ResultsStep.tsx
  - apps/frontend/src/features/configure/ConfigureStep.tsx
  - apps/frontend/src/features/history/BatchHistoryCard.tsx
autonomous: true

must_haves:
  truths:
    - "Loading an archived batch from history displays that batch's own fields with correct OCR data, not the current session's fields"
    - "All export formats (CSV, JSON, LIDO-XML, EAD, etc.) export correct batch data with proper field names after loading from archive"
    - "After completing a scan, navigating back to Configure shows a clear message that the batch was already created, not a cryptic 400 error"
    - "After cancelling mid-scan, navigating back to Configure shows the same explanatory message with disabled Commence Processing button"
    - "Batches created on the same day have distinguishable names (includes time, not just date)"
    - "Batch archive cards show the unique batch ID as a subtitle for disambiguation"
  artifacts:
    - path: "apps/frontend/src/features/results/ResultsStep.tsx"
      provides: "Field labels derived from results data via useMemo, not from store fields[]"
      contains: "useMemo"
    - path: "apps/frontend/src/features/configure/ConfigureStep.tsx"
      provides: "batchId guard on Commence Processing button + explanatory message"
      contains: "batchId"
    - path: "apps/frontend/src/features/history/BatchHistoryCard.tsx"
      provides: "Unique batch_name displayed as subtitle"
      contains: "batch.batch_name"
  key_links:
    - from: "apps/frontend/src/features/results/ResultsStep.tsx"
      to: "useResultsExport"
      via: "fieldLabels passed to useResultsExport hook"
      pattern: "useResultsExport.*fieldLabels"
    - from: "apps/frontend/src/features/configure/ConfigureStep.tsx"
      to: "wizardStore"
      via: "batchId read from store to guard button"
      pattern: "batchId"
---

<objective>
Fix the 4 highest-severity bugs: batch data isolation (BUG-06 CRITICAL, BUG-07 CRITICAL), session lifecycle (BUG-13 HIGH, BUG-15 MEDIUM), and batch name uniqueness (BUG-05 MEDIUM).

Purpose: These bugs corrupt all exports when reviewing archived batches and produce cryptic 400 errors when re-processing. They are the most impactful user-facing issues.
Output: ResultsStep derives fields from batch data (not store), ConfigureStep guards against stale sessions, batch names are distinguishable.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-RESEARCH.md
@apps/frontend/src/features/results/ResultsStep.tsx
@apps/frontend/src/features/configure/ConfigureStep.tsx
@apps/frontend/src/features/history/BatchHistoryCard.tsx
@apps/frontend/src/store/wizardStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Derive field labels from results data instead of store fields (BUG-06 + BUG-07)</name>
  <files>apps/frontend/src/features/results/ResultsStep.tsx</files>
  <action>
In `ResultsStep.tsx`, replace the line:
```typescript
const fieldLabels = fields.map((f) => f.label);
```
with a `useMemo` that derives field names from the actual results data:
```typescript
const fieldLabels = useMemo(() => {
  if (results.length === 0) return [];
  const seen = new Map<string, number>();
  results.forEach((r) => {
    Object.keys(r.data).forEach((k) => {
      if (!seen.has(k)) seen.set(k, seen.size);
    });
  });
  return Array.from(seen.entries())
    .sort((a, b) => a[1] - b[1])
    .map(([k]) => k)
    .filter((k) => !k.startsWith('_'));
}, [results]);
```

This uses a Map to collect all unique field keys from all result rows, preserving insertion order (first occurrence across all rows). Internal fields prefixed with `_` (like `_entries`, `_entry_count`) are filtered out.

Also add `useMemo` to the React import at the top if not already present.

Remove `fields` from the destructured `useWizardStore()` call since it is no longer used in this component (unless other code in the file still references it — check before removing). This fixes BUG-06 (wrong fields displayed) and BUG-07 (wrong exports) simultaneously, since `fieldLabels` is passed directly to `useResultsExport`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (no type errors)
2. Grep for `fields.map` in ResultsStep.tsx returns no results
3. Grep for `useMemo` in ResultsStep.tsx confirms the new derivation exists
  </verify>
  <done>
ResultsStep derives field labels from `results[].data` keys via useMemo. The `fields` store dependency is removed. Archived batches display their own field names. All exports receive correct fieldLabels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Guard stale session re-processing + improve batch name uniqueness (BUG-13 + BUG-15 + BUG-05)</name>
  <files>apps/frontend/src/features/configure/ConfigureStep.tsx, apps/frontend/src/features/history/BatchHistoryCard.tsx</files>
  <action>
**ConfigureStep.tsx — BUG-13/15 fix:**

1. Add `batchId` to the destructured `useWizardStore()` call:
```typescript
const { files, fields, sessionId, batchId, provider, model, setStep, setBatchId, promptTemplate } = useWizardStore();
```

2. Add `batchId !== null` to the "Commence Processing" button's `disabled` prop:
```typescript
disabled={fields.length === 0 || isPending || !batchName.trim() || batchId !== null}
```

3. Add an explanatory message above the WizardNav when `batchId` is not null. Insert just before the `<WizardNav` component:
```tsx
{batchId && (
  <div className="flex items-center gap-2 p-4 bg-archive-sepia/5 border border-archive-sepia/20 rounded-lg text-archive-ink/60 text-sm italic font-serif">
    <Info className="w-4 h-4 flex-shrink-0 text-archive-sepia/60" />
    <span>A batch has already been created for this session. Use <strong>"Start New Batch"</strong> from the Results step to begin fresh.</span>
  </div>
)}
```
(`Info` is already imported from lucide-react in ConfigureStep.)

**ConfigureStep.tsx — BUG-05 fix (sub-fix 1: unique default name):**

Change the `batchName` useState initializer from:
```typescript
const [batchName, setBatchName] = useState(`Batch_${new Date().toISOString().slice(0, 10)}`);
```
to:
```typescript
const [batchName, setBatchName] = useState(`Batch_${new Date().toISOString().slice(0, 16).replace('T', '_')}`);
```
This produces names like `Batch_2026-02-23_14:30` instead of `Batch_2026-02-23`, making same-day batches distinguishable.

**BatchHistoryCard.tsx — BUG-05 fix (sub-fix 2: show unique batch ID):**

In `BatchHistoryCard.tsx`, add the unique `batch_name` as a subtitle below the custom_name heading. Change the top row section from:
```tsx
<h3 className="font-serif text-lg text-archive-ink leading-tight">{batch.custom_name}</h3>
```
to:
```tsx
<div className="flex flex-col gap-0.5">
  <h3 className="font-serif text-lg text-archive-ink leading-tight">{batch.custom_name}</h3>
  <span className="font-mono text-[10px] text-archive-ink/40 leading-tight truncate" title={batch.batch_name}>{batch.batch_name}</span>
</div>
```
This shows the full unique batch identifier (with timestamp + UUID suffix) as a subtle monospace subtitle.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Grep for `batchId !== null` in ConfigureStep.tsx confirms the guard is present
3. Grep for `batch.batch_name` in BatchHistoryCard.tsx confirms the subtitle exists
4. Grep for `slice(0, 16)` in ConfigureStep.tsx confirms the time-inclusive default name
  </verify>
  <done>
ConfigureStep disables "Commence Processing" when batchId is already set, with a clear explanatory message. Default batch name includes time for uniqueness. BatchHistoryCard shows unique batch ID as subtitle.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/frontend && npx tsc --noEmit`
2. No remaining references to `fields.map((f) => f.label)` in ResultsStep.tsx
3. ConfigureStep includes batchId guard on the button disabled prop
4. BatchHistoryCard displays batch.batch_name subtitle
</verification>

<success_criteria>
- Loading an archived batch from history shows correct field names derived from results data
- Exports produce correct columns matching the batch's actual OCR data
- Clicking "Commence Processing" after a batch was already created shows disabled button + message (not 400 error)
- Default batch names include time component (HH:MM)
- Archive cards show unique batch identifier for disambiguation
</success_criteria>

<output>
After completion, create `.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-01-SUMMARY.md`
</output>

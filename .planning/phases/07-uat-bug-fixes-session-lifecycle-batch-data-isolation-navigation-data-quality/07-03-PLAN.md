---
phase: 07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/app/services/batch_manager.py
  - apps/backend/app/api/api_v1/endpoints/batches.py
  - apps/frontend/src/features/results/ResultsTable.tsx
  - apps/frontend/src/features/results/useResultsExport.ts
  - apps/frontend/src/features/processing/useProcessingWebSocket.ts
  - apps/frontend/index.html
autonomous: true

must_haves:
  truths:
    - "Batch archive shows correct completion status (completed/cancelled/failed) instead of 'uploaded' for all batches"
    - "Edited cell values do not contain trailing newlines after committing via blur or Ctrl+Enter"
    - "LIDO-XML export uses generic 'Karteikarte' instead of hardcoded 'Tonbandkarteikarte'"
    - "Browser tab title shows 'Indexcards OCR' instead of 'frontend'"
    - "No WebSocket race condition warning ('closed before connection established') in browser console"
  artifacts:
    - path: "apps/backend/app/services/batch_manager.py"
      provides: "update_batch_status method for post-processing status persistence"
      contains: "update_batch_status"
    - path: "apps/backend/app/api/api_v1/endpoints/batches.py"
      provides: "Calls update_batch_status after final broadcast_progress"
      contains: "update_batch_status"
    - path: "apps/frontend/src/features/results/ResultsTable.tsx"
      provides: "EditableCell commit trims trailing newlines"
      contains: "replace.*\\\\n"
    - path: "apps/frontend/src/features/results/useResultsExport.ts"
      provides: "Generic Karteikarte term in LIDO export"
      contains: "Karteikarte"
    - path: "apps/frontend/src/features/processing/useProcessingWebSocket.ts"
      provides: "WebSocket readyState guard on cleanup close"
      contains: "CONNECTING"
    - path: "apps/frontend/index.html"
      provides: "Correct page title"
      contains: "Indexcards OCR"
  key_links:
    - from: "apps/backend/app/api/api_v1/endpoints/batches.py"
      to: "apps/backend/app/services/batch_manager.py"
      via: "run_ocr_task calls batch_manager.update_batch_status"
      pattern: "batch_manager\\.update_batch_status"
---

<objective>
Fix data quality and cosmetic bugs: batch status persistence (BUG-04 MEDIUM), trailing newline in edited cells (BUG-08 MEDIUM), LIDO hardcode (BUG-09 LOW), page title (BUG-10 LOW), and WebSocket race condition (BUG-11 MEDIUM). BUG-14 (OCR field overflow) is deferred as a prompt engineering issue out of scope for this phase.

Purpose: These fixes improve data quality (correct status display, clean cell values) and polish (correct title, no console warnings, generic export terms).
Output: Backend persists batch status after OCR completion; frontend trims trailing newlines, uses generic LIDO term, shows correct title, and handles WS cleanup without console warnings.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-RESEARCH.md
@apps/backend/app/services/batch_manager.py
@apps/backend/app/api/api_v1/endpoints/batches.py
@apps/frontend/src/features/results/ResultsTable.tsx
@apps/frontend/src/features/results/useResultsExport.ts
@apps/frontend/src/features/processing/useProcessingWebSocket.ts
@apps/frontend/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persist batch status after OCR completion (BUG-04)</name>
  <files>apps/backend/app/services/batch_manager.py, apps/backend/app/api/api_v1/endpoints/batches.py</files>
  <action>
**batch_manager.py — add `update_batch_status` method:**

Add a new method to the `BatchManager` class (after `_record_history`):
```python
def update_batch_status(self, batch_name: str, status: str) -> None:
    """Update the status field of a batch in batches.json."""
    history_file = Path(settings.BATCHES_HISTORY_FILE)
    if not history_file.exists():
        return
    try:
        with open(history_file, "r") as f:
            history = json.load(f)
        for entry in history:
            if entry.get("batch_name") == batch_name:
                entry["status"] = status
                break
        with open(history_file, "w") as f:
            json.dump(history, f, indent=2)
    except Exception:
        pass  # non-critical — status display is cosmetic
```

This follows the same read-modify-write JSON pattern used by `_record_history` and `get_history`. No file locking added (consistent with existing code style; low concurrency risk per research).

**batches.py — call `update_batch_status` from `run_ocr_task`:**

In the `run_ocr_task` function, after the final `broadcast_progress` calls (both in the success path and the edge-case path), add a call to persist the status.

After the success/cancel path (after the `await ws_manager.broadcast_progress(batch_name, last_state)` or the edge-case `await ws_manager.broadcast_progress(batch_name, final_state)` call), add:
```python
# Persist final status to batches.json
final_status = "cancelled" if cancel_event.is_set() else "completed"
batch_manager.update_batch_status(batch_name, final_status)
```

After the exception path (after the failed `broadcast_progress` calls), add:
```python
batch_manager.update_batch_status(batch_name, "failed")
```

Place the `update_batch_status` calls in the `finally` block or at the end of both the try and except blocks. The cleanest approach: add a single call at the end of the try block (before the except), and one in the except block. Do NOT put it in the finally block because the status variable differs between success and failure paths.

Make sure `batch_manager` is imported at the top of `batches.py` if not already:
```python
from app.services.batch_manager import batch_manager
```
(Check existing imports — it may already be imported.)
  </action>
  <verify>
1. `cd apps/backend && python -c "from app.services.batch_manager import batch_manager; print('OK')"` succeeds
2. Grep for `update_batch_status` in batch_manager.py confirms the method exists
3. Grep for `update_batch_status` in batches.py confirms it is called in both success and failure paths
  </verify>
  <done>
Batch status is persisted to batches.json as "completed", "cancelled", or "failed" after OCR processing finishes. Archive correctly shows completion status instead of perpetual "uploaded".
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix trailing newline, LIDO hardcode, page title, and WS race condition (BUG-08 + BUG-09 + BUG-10 + BUG-11)</name>
  <files>apps/frontend/src/features/results/ResultsTable.tsx, apps/frontend/src/features/results/useResultsExport.ts, apps/frontend/src/features/processing/useProcessingWebSocket.ts, apps/frontend/index.html</files>
  <action>
**BUG-08 — Trailing newline fix in EditableCell (ResultsTable.tsx):**

In the `EditableCell` component, update the `commit` function to strip trailing newlines:
```typescript
const commit = () => {
  setEditing(false);
  const trimmed = draft.replace(/\n+$/, '');
  if (trimmed !== value) onCommit(trimmed);
};
```
This replaces the current:
```typescript
const commit = () => {
  setEditing(false);
  if (draft !== value) onCommit(draft);
};
```
Only trailing newlines are stripped (not leading, not spaces, not internal newlines). This handles the case where a user presses Enter (inserting a newline) then blurs or Ctrl+Enter commits — the accidental trailing newline is removed.

**BUG-09 — LIDO hardcode fix (useResultsExport.ts):**

Find the line containing `<lido:term>Tonbandkarteikarte</lido:term>` and replace with:
```typescript
<lido:term>Karteikarte</lido:term>
```
"Karteikarte" is the generic German archival term for index card, appropriate for any collection type.

**BUG-10 — Page title fix (index.html):**

Change:
```html
<title>frontend</title>
```
to:
```html
<title>Indexcards OCR</title>
```

**BUG-11 — WebSocket race condition fix (useProcessingWebSocket.ts):**

Replace the cleanup return in the useEffect:
```typescript
return () => {
  const ref = wsRef.current;
  wsRef.current = null;
  ref?.close();
};
```
with a readyState-guarded version:
```typescript
return () => {
  const ref = wsRef.current;
  wsRef.current = null;
  if (ref) {
    if (ref.readyState === WebSocket.CONNECTING) {
      // Avoid "WebSocket is closed before connection is established" warning
      ref.onopen = () => ref.close();
    } else {
      ref.close();
    }
  }
};
```
When the WebSocket is still in CONNECTING state (readyState === 0), calling `close()` directly triggers a browser console warning. Instead, we set `onopen` to close after the connection completes. The `wsRef.current = null` guard above already prevents the reconnect loop in `ws.onclose`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (no type errors)
2. Grep for `replace.*\\\\n` in ResultsTable.tsx confirms trailing newline trim
3. Grep for `Karteikarte` in useResultsExport.ts confirms generic term (and `Tonbandkarteikarte` no longer appears)
4. Grep for `Indexcards OCR` in index.html confirms correct title
5. Grep for `CONNECTING` in useProcessingWebSocket.ts confirms readyState guard
  </verify>
  <done>
EditableCell trims trailing newlines on commit. LIDO export uses generic "Karteikarte" term. Page title shows "Indexcards OCR". WebSocket cleanup guards against CONNECTING state to prevent console warning.
  </done>
</task>

</tasks>

<verification>
1. Backend: `cd apps/backend && python -c "from app.services.batch_manager import batch_manager; print('OK')"`
2. Frontend: `cd apps/frontend && npx tsc --noEmit`
3. Grep verifications for all 5 bug fixes as listed in task verify sections
</verification>

<success_criteria>
- Batch archive shows "completed"/"cancelled"/"failed" instead of perpetual "uploaded"
- Editing a cell and pressing Enter then blurring does not leave trailing newlines
- LIDO-XML export uses "Karteikarte" for all records
- Browser tab shows "Indexcards OCR"
- No "WebSocket closed before connection established" warning in console
</success_criteria>

<output>
After completion, create `.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-03-SUMMARY.md`
</output>

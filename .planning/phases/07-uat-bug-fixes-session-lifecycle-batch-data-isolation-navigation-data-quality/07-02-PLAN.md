---
phase: 07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/components/Sidebar.tsx
  - apps/frontend/src/store/wizardStore.ts
  - apps/frontend/src/features/configure/TemplateSelector.tsx
  - apps/frontend/src/features/upload/FileList.tsx
autonomous: true

must_haves:
  truths:
    - "After loading a batch from archive, clicking '4. Results' in the sidebar navigates to the results view"
    - "Sidebar '3. Processing' step is never directly accessible via sidebar click (by design)"
    - "Template name persists when navigating away from Configure and returning — shows the selected template name, not 'Custom / Blank Slate'"
    - "File removal confirmation toast stays visible long enough (10s) for the user to click Confirm or Cancel"
  artifacts:
    - path: "apps/frontend/src/components/Sidebar.tsx"
      provides: "Conditional sidebar navigation to results when batchId is set"
      contains: "batchId"
    - path: "apps/frontend/src/store/wizardStore.ts"
      provides: "selectedTemplateName field persisted in Zustand"
      contains: "selectedTemplateName"
    - path: "apps/frontend/src/features/configure/TemplateSelector.tsx"
      provides: "selectedLabel initialized from store, synced back on selection"
      contains: "selectedTemplateName"
    - path: "apps/frontend/src/features/upload/FileList.tsx"
      provides: "Toast with 10s duration for file removal confirmation"
      contains: "duration"
  key_links:
    - from: "apps/frontend/src/components/Sidebar.tsx"
      to: "wizardStore"
      via: "batchId selector for conditional results navigation"
      pattern: "useWizardStore.*batchId"
    - from: "apps/frontend/src/features/configure/TemplateSelector.tsx"
      to: "wizardStore"
      via: "selectedTemplateName read/write for persistence"
      pattern: "selectedTemplateName"
---

<objective>
Fix navigation and state restoration bugs: sidebar navigation to Results when batch is loaded (BUG-01/02 HIGH), template name persistence across step transitions (BUG-03 MEDIUM), and toast timing for file removal confirmation (BUG-12 MEDIUM).

Purpose: These bugs prevent users from navigating to results after loading archived batches, lose the template name on step transitions, and dismiss action-required toasts before users can interact.
Output: Sidebar allows results navigation when batchId is set, template name persists in Zustand, toast stays visible for 10 seconds.
</objective>

<execution_context>
@/Users/martinhess/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martinhess/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-RESEARCH.md
@apps/frontend/src/components/Sidebar.tsx
@apps/frontend/src/store/wizardStore.ts
@apps/frontend/src/features/configure/TemplateSelector.tsx
@apps/frontend/src/features/upload/FileList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Allow sidebar navigation to Results when batchId is set (BUG-01 + BUG-02)</name>
  <files>apps/frontend/src/components/Sidebar.tsx</files>
  <action>
**BUG-01/02 fix — conditional sidebar results navigation:**

1. Add a `batchId` selector to the Sidebar component:
```typescript
const batchId = useWizardStore((state) => state.batchId);
```

2. Replace the `handleStepClick` function with conditional logic:
```typescript
const handleStepClick = (stepKey: WizardStep) => {
  // Processing is never accessible via sidebar (by design)
  if (stepKey === 'processing') return;
  // Results: allow sidebar click only when a batch is loaded (batchId set)
  if (stepKey === 'results') {
    if (batchId) {
      setStep('results');
    }
    return;
  }
  // Upload/Configure: allow clicking completed steps to go back
  const status = getStepStatus(stepKey);
  if (status === 'complete') {
    setStep(stepKey);
  }
};
```

3. Update the `isClickable` logic in the STEPS.map render to reflect the new sidebar behavior:
```typescript
const isClickable =
  (isComplete && step.key !== 'processing' && step.key !== 'results') ||
  (step.key === 'results' && !!batchId);
```

This allows clicking "4. Results" in the sidebar when any batch (completed or loaded from archive) exists. Processing remains inaccessible via sidebar per the locked decision: "Display-only; step transitions only via store actions to enforce wizard order."
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Grep for `if (batchId)` in Sidebar.tsx confirms the conditional results navigation
3. Grep for `stepKey === 'processing'` in Sidebar.tsx confirms processing is still blocked
  </verify>
  <done>
Sidebar allows navigation to "4. Results" when batchId is set (batch loaded from archive or completed). Processing remains inaccessible via sidebar click. Decision about wizard-order enforcement is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Persist template name in Zustand + extend toast duration (BUG-03 + BUG-12)</name>
  <files>apps/frontend/src/store/wizardStore.ts, apps/frontend/src/features/configure/TemplateSelector.tsx, apps/frontend/src/features/upload/FileList.tsx</files>
  <action>
**BUG-03 fix — persist selectedTemplateName in Zustand:**

In `wizardStore.ts`:

1. Add to `WizardState` interface:
```typescript
selectedTemplateName: string | null;
setSelectedTemplateName: (name: string | null) => void;
```

2. Add to `initialState`:
```typescript
selectedTemplateName: null as string | null,
```

3. Add the action in the `create()` block (alongside other setters):
```typescript
setSelectedTemplateName: (selectedTemplateName) => set({ selectedTemplateName }),
```

4. Add `selectedTemplateName` to the `partialize` return object:
```typescript
selectedTemplateName: state.selectedTemplateName,
```
This ensures the template name survives page reloads and step navigation.

In `TemplateSelector.tsx`:

1. Add `selectedTemplateName` and `setSelectedTemplateName` to the destructured store:
```typescript
const { setFields, setPromptTemplate, selectedTemplateName, setSelectedTemplateName } = useWizardStore();
```

2. Initialize `selectedLabel` from the store value:
```typescript
const [selectedLabel, setSelectedLabel] = useState(selectedTemplateName ?? 'Custom / Blank Slate');
```

3. In `handleSelectBlank`, also call `setSelectedTemplateName(null)`:
```typescript
const handleSelectBlank = () => {
  setFields([]);
  setPromptTemplate(null);
  setSelectedLabel('Custom / Blank Slate');
  setSelectedTemplateName(null);
  setIsOpen(false);
  toast.info('Cleared all extraction fields.');
};
```

4. In `handleSelectTemplate`, also call `setSelectedTemplateName(name)`:
```typescript
const handleSelectTemplate = (_id: string, name: string, fields: string[], promptTemplate?: string | null) => {
  // ... existing field/prompt logic ...
  setSelectedLabel(name);
  setSelectedTemplateName(name);
  setIsOpen(false);
  toast.success(`Applied template: ${name}`);
};
```

**BUG-12 fix — toast duration for file removal:**

In `FileList.tsx`, add `duration: 10000` to the toast call in `handleDelete`:
```typescript
toast(`Remove ${name}?`, {
  duration: 10000,
  action: {
    label: 'Confirm',
    onClick: () => {
      removeFile(id);
      toast.success(`${name} removed from batch.`);
    },
  },
  cancel: {
    label: 'Cancel',
    onClick: () => {},
  },
});
```
10 seconds gives the user plenty of time to read the confirmation and click Confirm or Cancel.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Grep for `selectedTemplateName` in wizardStore.ts confirms field + action + partialize
3. Grep for `selectedTemplateName` in TemplateSelector.tsx confirms store integration
4. Grep for `duration: 10000` in FileList.tsx confirms the extended toast duration
  </verify>
  <done>
Template name persists in Zustand across step navigation and page reloads. TemplateSelector initializes from persisted value. File removal toast stays visible for 10 seconds.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd apps/frontend && npx tsc --noEmit`
2. Sidebar has batchId-conditional results navigation
3. wizardStore includes selectedTemplateName in state, actions, and partialize
4. TemplateSelector reads/writes selectedTemplateName from/to store
5. FileList toast has 10s duration
</verification>

<success_criteria>
- After loadBatchForReview, clicking "4. Results" in sidebar navigates to results view
- Processing sidebar item remains non-clickable
- Template name survives navigation away from Configure and back
- File removal confirmation toast stays visible for ~10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/07-uat-bug-fixes-session-lifecycle-batch-data-isolation-navigation-data-quality/07-02-SUMMARY.md`
</output>
